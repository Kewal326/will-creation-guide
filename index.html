<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahay | Free Will Creator</title>
    <meta name="description" content="Create your legal Will in minutes. Free, secure, and easy to use.">
    <link rel="icon" type="image/jpeg" href="favicon.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .step-section {
            display: none;
        }

        .step-section.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #save-toast {
            transition: opacity 0.5s;
            opacity: 0;
        }

        #save-toast.show {
            opacity: 1;
        }

        .error-border {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }

        /* Custom Scrollbar for modal content if needed */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Asset Card Transitions */
        .asset-body-transition {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Preview Paper Style */
        .preview-paper {
            background: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            min-height: 297mm;
            padding: 25mm;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            line-height: 1.6;
            font-size: 12pt;
        }

        .preview-placeholder {
            color: #9ca3af;
            background-color: #f3f4f6;
            padding: 0 4px;
            border-radius: 2px;
            font-style: italic;
        }

        /* Bottom Sheet Animation */
        #asset-sheet-container {
            transform: translateY(100%);
        }

        @media (max-width: 768px) {
            .asset-item {
                cursor: pointer;
            }
        }
    </style>
    <link rel="stylesheet" href="/index.css">
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
</head>

<body class="bg-slate-100 text-slate-800 font-sans pb-20" onload="initApp()">

    <!-- Header -->
    <header class="bg-indigo-900 text-white shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center px-3 sm:px-4 pt-2 sm:pt-3 pb-1">
            <div class="cursor-pointer" onclick="goToStep(0)">
                <h1 class="text-base sm:text-xl font-bold">Sahay <span class="text-indigo-300 font-normal">| Will
                        Creator</span></h1>
                <span id="save-status"
                    class="text-[9px] sm:text-[10px] bg-green-600 px-1 rounded text-white tracking-widest transition-colors">READY</span>
            </div>
            <div class="flex gap-1.5 sm:gap-2">
                <button onclick="toggleLanguage()"
                    class="bg-white text-indigo-700 hover:bg-indigo-50 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-bold transition border border-indigo-200">
                    <span class="hidden sm:inline text-lg mr-1">üåê</span><span id="lang-toggle-text">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
                </button>
                <button onclick="openPreview()"
                    class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-bold transition border border-indigo-200">
                    <span class="hidden sm:inline text-lg mr-1">üëÅÔ∏è</span><span data-i18n="btnPreview">Preview</span>
                </button>
            </div>
        </div>

        <!-- Milestone Stepper -->
        <div class="w-full bg-indigo-900 pb-6 sm:pb-8 pt-1 sm:pt-2 px-3 sm:px-4">
            <div class="max-w-3xl mx-auto relative flex items-center justify-between">
                <!-- Background Line -->
                <div class="absolute left-0 top-[15px] w-full h-0.5 bg-indigo-950 rounded z-0"></div>
                <!-- Active Line -->
                <div id="stepper-line"
                    class="absolute left-0 top-[15px] h-0.5 bg-green-500 rounded transition-all duration-500 z-0"
                    style="width: 0%"></div>

                <!-- Steps -->
                <div id="step-node-0" onclick="navigateToStep(0)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        1</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbWhy">Why</span>
                </div>
                <div id="step-node-1" onclick="navigateToStep(1)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        2</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbYou">You</span>
                </div>
                <div id="step-node-2" onclick="navigateToStep(2)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        3</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbExecutor">Executor</span>
                </div>
                <div id="step-node-3" onclick="navigateToStep(3)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        4</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbHeirs">Heirs</span>
                </div>
                <div id="step-node-4" onclick="navigateToStep(4)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        5</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbAssets">Assets</span>
                </div>
                <div id="step-node-5" onclick="navigateToStep(5)"
                    class="relative z-10 flex flex-col items-center w-8 cursor-pointer">
                    <div
                        class="step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold bg-indigo-900 border-indigo-500 text-indigo-400 transition-all duration-300">
                        6</div>
                    <span
                        class="absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium text-indigo-400 transition-colors duration-300"
                        data-i18n="pbGenerate">Generate</span>
                </div>
            </div>
        </div>
    </header>

    <div id="save-toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded text-xs z-50">Draft
        Saved...</div>

    <main class="max-w-5xl mx-auto p-6 mt-6 bg-white shadow-xl rounded-lg min-h-[600px] relative">

        <!-- STEP 0: EDUCATION -->
        <div id="step-0" class="step-section active space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-slate-800" data-i18n="s0Title">1. Why Create a Will?</h2>

            <!-- DISCLAIMER -->
            <div class="bg-gray-100 border-l-4 border-gray-500 p-4 rounded shadow-sm">
                <p class="text-xs text-gray-600 italic leading-relaxed">
                    <strong data-i18n="disclaimerTitle">Disclaimer:</strong> <span data-i18n="disclaimerText">This
                        website is a self-help educational tool and does not provide legal advice. The generated
                        document is a draft based on standard Indian legal templates. For complex estates, disputes, or
                        tax planning, please consult a qualified lawyer. This tool has no official legal
                        standing.</span>
                </p>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div class="bg-orange-50 border-l-4 border-orange-500 p-6 rounded shadow-sm">
                    <h3 class="font-bold text-orange-900 text-xl mb-2" data-i18n="nomineeTitle">‚ö†Ô∏è The Truth About
                        "Nominees"</h3>
                    <div class="text-sm text-slate-700 space-y-2">
                        <p data-i18n="nomineeText">There is a dangerous misconception in India that a Nominee becomes
                            the owner
                            of the asset upon death. <strong>This is false.</strong></p>
                        <p><strong data-i18n="legalRealityTitle">The Legal Reality:</strong> <span
                                data-i18n="legalRealityText">A Nominee is merely a "Trustee" or "Custodian." Their
                                only job is to hold the money/asset until it can be distributed to the <strong>Legal
                                    Heirs</strong>.</span></p>
                        <p><strong data-i18n="consequenceTitle">The Consequence:</strong> <span
                                data-i18n="consequenceText">If you don't write a Will, your Nominee might have to fight
                                legal battles with other relatives who claim a share of your wealth under religious
                                succession laws. A Will overrides this and makes your wish the final law.</span></p>
                    </div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded shadow-sm">
                    <h3 class="font-bold text-blue-900 text-xl mb-2" data-i18n="offlineTitle">üìù You Can Do This Offline
                        (No App Needed)</h3>
                    <div class="text-sm text-slate-700 space-y-2">
                        <p data-i18n="offlineText">We built this app to help you, but you should know your rights. You
                            can create a perfectly
                            valid Will on a plain piece of A4 paper.</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong data-i18n="noStampTitle">No Stamp Paper:</strong> <span
                                    data-i18n="noStampText">A Will does NOT need to be written on stamp paper.</span>
                            </li>
                            <li><strong data-i18n="handwrittenTitle">Handwritten is Best:</strong> <span
                                    data-i18n="handwrittenText">Courts often trust handwritten wills more than
                                    typed ones as they are harder to forge.</span></li>
                            <li><strong data-i18n="goldenRuleTitle">The Golden Rule:</strong> <span
                                    data-i18n="goldenRuleText">You must sign it in the presence of <strong>Two
                                        Witnesses</strong>, and they must sign it immediately after you.</span></li>
                            <li><strong data-i18n="registrationTitle">Registration:</strong> <span
                                    data-i18n="registrationText">While optional, registering your Will at the
                                    Sub-Registrar's office is highly recommended.</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- RESUME BANNER -->
            <div id="resume-banner" class="hidden bg-green-50 border border-green-200 p-4 rounded text-center mt-4">
                <p class="font-bold text-green-800 mb-3" data-i18n="resumeDraftTitle">We found a saved draft!</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-3">
                    <button onclick="resumeJourney()"
                        class="bg-green-600 text-white font-bold py-2 px-6 rounded shadow hover:bg-green-700 text-sm"
                        data-i18n="btnResume">Resume
                        Draft</button>
                    <button onclick="startFresh()"
                        class="bg-white border border-red-300 text-red-500 font-bold py-2 px-4 rounded hover:bg-red-50 text-sm"
                        data-i18n="btnStartFresh">Start
                        Fresh (Delete Data)</button>
                </div>
            </div>

            <div id="start-btn-container" class="text-center mt-6">
                <button onclick="updateMaxReached(1); goToStep(1)"
                    class="bg-indigo-600 text-white text-lg font-bold py-4 px-10 rounded-full shadow-lg hover:bg-indigo-700 transition transform hover:-translate-y-1"
                    data-i18n="btnStart">Start
                    Creating My Will</button>
            </div>
        </div>

        <!-- STEP 1: YOUR DETAILS & RELIGION (Merged) -->
        <div id="step-1" class="step-section space-y-5 fade-in">
            <h2 class="text-2xl font-bold text-gray-700 border-b pb-2" data-i18n="s1Title">2. Your Details & Religion
            </h2>

            <!-- RELIGION SECTION (Merged) -->
            <div class="bg-indigo-50 border border-indigo-200 p-4 rounded text-sm text-indigo-900 mb-4">
                <strong data-i18n="legalContextTitle">Legal Context:</strong> <span
                    data-i18n="legalContextText">Succession laws in India differ based on religion.</span>
            </div>
            <div class="space-y-2 mb-6 border-b pb-6">
                <label class="block font-medium"><span data-i18n="lblReligion">Select your Religion:</span> <span
                        class="text-red-500">*</span></label>
                <select id="religionSelector" onchange="removeError(this); checkReligion(); saveData()"
                    class="w-full border p-3 rounded bg-white required-field">
                    <option value="" data-i18n="optSelect">-- Select --</option>
                    <option value="Hindu" data-i18n="optHindu">Hindu (incl. Sikh, Jain, Buddhist)</option>
                    <option value="Christian" data-i18n="optChristian">Christian / Parsi</option>
                    <option value="Muslim" data-i18n="optMuslim">Muslim</option>
                    <option value="Other" data-i18n="optOther">Other</option>
                </select>

                <div id="other-religion-wrapper" class="hidden mt-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="lblCustomReligion">Please
                        specify your religion:</label>
                    <input type="text" id="customReligion" oninput="saveData()" class="w-full border p-3 rounded"
                        placeholder="e.g. Jewish, Bah√° º√≠" data-i18n-placeholder="phCustomReligion">
                </div>

                <div id="muslim-warning"
                    class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 rounded mt-2 shadow-sm">
                    <h4 class="font-bold text-blue-900 text-sm mb-2 flex items-center gap-2">
                        <span class="text-xl">‚ÑπÔ∏è</span> <span data-i18n="muslimWarningTitle">Important for Muslims
                            (Sharia Law)</span>
                    </h4>
                    <div class="text-xs text-blue-800 space-y-2 leading-relaxed">
                        <p data-i18n="muslimWarningText1">Under Islamic Succession Laws, the testamentary freedom is
                            limited:</p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li><strong data-i18n="mwRuleTitle">The 1/3rd Rule:</strong> <span
                                    data-i18n="mwRuleText">You can generally only bequeath up to 1/3rd of your total
                                    estate through a Will. The remaining 2/3rds must be distributed to your legal heirs
                                    according to fixed shares in the Quran.</span>
                            </li>
                            <li><strong data-i18n="mwConsentTitle">Consent Required:</strong> <span
                                    data-i18n="mwConsentText">If you wish to give more than 1/3rd, or if you wish to
                                    give any amount to a legal heir who is already receiving a fixed share, you
                                    typically need the consent of all other heirs after your death. Without this
                                    consent, that part of the Will may be invalid.</span></li>
                        </ul>
                    </div>
                </div>

                <div id="hindu-warning"
                    class="hidden bg-orange-50 border-l-4 border-orange-500 p-4 rounded mt-2 shadow-sm">
                    <h4 class="font-bold text-orange-900 text-sm mb-2 flex items-center gap-2">
                        <span class="text-xl">‚ÑπÔ∏è</span> <span data-i18n="hinduWarningTitle">Hindu Succession Act</span>
                    </h4>
                    <div class="text-xs text-orange-800 space-y-2 leading-relaxed">
                        <p class="mb-2"><strong data-i18n="hwNoteTitle">Note:</strong> <span data-i18n="hwNoteText">For
                                the purpose of succession laws in India, Sikhs, Jains, and Buddhists are governed by the
                                Hindu Succession Act.</span>
                        </p>
                        <h5 class="font-bold" data-i18n="hwPropTitle">Ancestral vs. Self-Acquired Property:</h5>
                        <ul class="list-disc pl-4 space-y-1">
                            <li><strong data-i18n="hwSelfTitle">Self-Acquired Property:</strong> <span
                                    data-i18n="hwSelfText">Assets you earned or bought yourself. You have 100% freedom
                                    to give these to anyone you like.</span></li>
                            <li><strong data-i18n="hwAncestralTitle">Ancestral Property:</strong> <span
                                    data-i18n="hwAncestralText">Property inherited from up to 4 generations back. You
                                    cannot Will away the entire property, only your share of it. Other family members
                                    (coparceners) have a birthright in this property.</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- PERSONAL DETAILS -->
            <div class="grid gap-4">
                <div><label class="text-xs font-bold text-gray-500"><span data-i18n="lblFullName">Full Legal Name</span>
                        <span class="text-red-500">*</span></label><input type="text" id="myName"
                        oninput="removeError(this); saveData()" class="w-full border p-3 rounded required-field"
                        placeholder="e.g. Rahul Sharma" data-i18n-placeholder="phFullName"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500"><span data-i18n="lblFatherName">Parent / Spouse
                                Name</span> <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="myRelPrefix" onchange="saveData()"
                                class="w-24 sm:w-28 border p-3 rounded bg-white text-sm">
                                <option value="S/o" data-i18n="optSonOf">Son of</option>
                                <option value="D/o" data-i18n="optDaughterOf">Daughter of</option>
                                <option value="W/o" data-i18n="optWifeOf">Wife of</option>
                            </select>
                            <input type="text" id="fatherName" oninput="removeError(this); saveData()"
                                class="w-full border p-3 rounded required-field" placeholder="Name"
                                data-i18n-placeholder="phFatherName">
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500" data-i18n="lblDob">Date of Birth</label><input
                            type="date" id="myDob" onchange="saveData()" class="w-full border p-3 rounded bg-white">
                    </div>
                </div>

                <div><label class="text-xs font-bold text-gray-500"><span data-i18n="lblAddress">Permanent
                            Address</span> <span class="text-red-500">*</span></label><textarea id="myAddress"
                        oninput="removeError(this); saveData()" class="w-full border p-3 rounded h-20 required-field"
                        placeholder="Full Address" data-i18n-placeholder="phAddress"></textarea></div>

                <div>
                    <label class="text-xs font-bold text-gray-500"><span data-i18n="lblPlace">City/Place of Signing
                            Will</span> <span class="text-red-500">*</span></label>
                    <input type="text" id="myPlace" oninput="removeError(this); saveData()"
                        class="w-full border p-3 rounded required-field" placeholder="e.g. Mumbai, Maharashtra"
                        data-i18n-placeholder="phPlace">
                    <p class="text-[10px] text-gray-400 mt-1" data-i18n="placeHelper">This establishes the legal
                        jurisdiction.</p>
                </div>
            </div>
            <div class="flex justify-between pt-4">
                <button onclick="goToStep(0)" class="text-gray-500" data-i18n="btnBack">‚Üê Back</button>
                <button onclick="validateAndNext(1, 2)" class="bg-indigo-600 text-white px-6 py-2 rounded"
                    data-i18n="btnNextExecutor">Next: Executor</button>
            </div>
        </div>

        <!-- STEP 2: EXECUTOR (Renumbered) -->
        <div id="step-2" class="step-section space-y-5 fade-in">
            <h2 class="text-2xl font-bold text-gray-700 border-b pb-2" data-i18n="s2Title">3. The Executor</h2>
            <!-- Clean UI, No Box, No ID -->
            <div class="grid gap-4">

                <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 text-sm text-indigo-900 shadow-sm">
                    <div class="mb-3">
                        <strong class="text-indigo-900" data-i18n="s2InfoTitle">What is an Executor?</strong>
                        <p class="mt-1" data-i18n="s2InfoText">An executor is the person you trust to carry out the
                            instructions in your will. They will manage your estate, pay debts, and distribute assets to
                            beneficiaries. Note: An executor can also be a beneficiary in the same will - this is common
                            and perfectly legal.</p>
                    </div>
                    <div>
                        <p class="font-semibold text-indigo-900 mb-1" data-i18n="s2InfoRequirements">Requirements:</p>
                        <ul class="list-disc ml-4 space-y-1">
                            <li data-i18n="s2InfoReq1">Must be 18+ years old (Major)</li>
                            <li data-i18n="s2InfoReq2">Must be of sound mind</li>
                            <li data-i18n="s2InfoReq3">Should be trustworthy and responsible</li>
                        </ul>
                    </div>
                </div>

                <!-- Mobile Executor Cards Container -->
                <div id="mobile-executor-cards-container" class="md:hidden space-y-3 mb-4"></div>

                <!-- Desktop View -->
                <div id="desktop-executor-view" class="hidden md:block space-y-6">
                    <!-- Primary Executors Card -->
                    <div
                        class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all">
                        <!-- Header -->
                        <div class="bg-white p-4 border-b border-gray-100 flex items-center gap-3 select-none">
                            <div
                                class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xl">
                                P</div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm" data-i18n="s2PrimaryExecutors">Primary
                                    Executor(s)</h3>
                                <p class="text-xs text-gray-500" data-i18n="s2TipMultiple">Tip: Most wills have 1-3
                                    executors. Having many can slow decision-making.</p>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="p-4 md:p-6 bg-slate-50">
                            <!-- Primary Executors Container -->
                            <div id="primary-executors-container" class="space-y-4 mb-4"></div>

                            <!-- Add Primary Executor Button -->
                            <button onclick="addExecutorRow(true)"
                                class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 transition flex items-center justify-center gap-2"
                                data-i18n="s2AddPrimary">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Another Primary Executor
                            </button>
                        </div>
                    </div>

                    <!-- Alternate Executor Card -->
                    <div
                        class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all">
                        <!-- Header -->
                        <div class="bg-white p-4 border-b border-gray-100 flex items-center gap-3 select-none">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 font-bold text-xl">
                                A</div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm" data-i18n="s2AlternateSection">Alternate
                                    Executor (Optional)</h3>
                                <p class="text-xs text-gray-500" data-i18n="s2AlternateInfo">Recommended: An alternate
                                    ensures someone can serve if your primary executor(s) cannot.</p>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="p-4 md:p-6 bg-slate-50">
                            <!-- Alternate Executor Container -->
                            <div id="alternate-executor-container" class="mb-4"></div>

                            <!-- Add Alternate Button (shown when no alternate exists) -->
                            <button id="btn-add-alternate" onclick="addExecutorRow(false)"
                                class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 transition flex items-center justify-center gap-2"
                                data-i18n="s2AddAlternate">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                + Add Alternate Executor
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="flex justify-between pt-4">
                    <button onclick="goToStep(1)" class="text-gray-500" data-i18n="btnBack">‚Üê Back</button>
                    <button onclick="validateAndMoveToBeneficiaries()"
                        class="bg-indigo-600 text-white px-6 py-2 rounded" data-i18n="btnNextBeneficiaries">Next:
                        Beneficiaries</button>
                </div>
            </div>
        </div>

        <!-- STEP 3: BENEFICIARIES (Renumbered) -->
        <div id="step-3" class="step-section space-y-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-700 border-b pb-2" data-i18n="s3Title">4. Your Beneficiaries</h2>

            <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm p-4 rounded shadow-sm">
                <div class="flex gap-3 items-start mb-3">
                    <span class="text-xl">üí°</span>
                    <div>
                        <strong class="text-blue-900" data-i18n="s3InfoTitle">What are Beneficiaries?</strong>
                        <p class="mt-1 text-blue-800" data-i18n="s3InfoText">Beneficiaries (also called heirs) are
                            people who will receive your assets after your death. They can be family members, friends,
                            or organizations.</p>
                    </div>
                </div>
                <div class="flex gap-3 items-start">
                    <span class="text-xl">üë•</span>
                    <div>
                        <p class="font-semibold text-blue-900 mb-1" data-i18n="s3InfoConditions">Who can be a
                            beneficiary:
                        </p>
                        <ul class="list-disc ml-4 space-y-1 text-blue-800">
                            <li data-i18n="s3InfoCond1">Any person (including minors with guardians)</li>
                            <li data-i18n="s3InfoCond2">Charitable organizations or trusts</li>
                            <li data-i18n="s3InfoCond3">Multiple people can share assets</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Beneficiary List Container -->
            <div id="beneficiary-container" class="space-y-4"></div>

            <button onclick="addBeneficiaryRow()"
                class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-600 font-semibold rounded hover:bg-blue-50 hover:shadow-md transition"
                data-i18n="btnAddBeneficiary">+
                Add New Beneficiary</button>

            <div class="flex justify-between pt-4">
                <button onclick="goToStep(2)" class="text-gray-500" data-i18n="btnBack">‚Üê Back</button>
                <button onclick="validateAndMoveToAssets()" class="bg-indigo-600 text-white px-6 py-2 rounded"
                    data-i18n="btnNextAssets">Next: Distribute Assets</button>
            </div>
        </div>

        <!-- STEP 4: ASSETS (Renumbered) -->
        <div id="step-4" class="step-section space-y-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-700 border-b pb-2" data-i18n="s4Title">5. Distribute Assets</h2>


            <!-- Privacy Warning Info Box -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded text-sm shadow-sm mb-4">
                <h3 class="font-bold text-blue-900 mb-2" data-i18n="s4TipsTitle">üí° Asset Identification Tips</h3>
                <p class="text-blue-800 mb-2" data-i18n="s4TipsText">You can describe assets in general terms or include
                    specific details to help your executor locate them.</p>
                <p class="text-blue-800 mt-3"><strong data-i18n="s4PrivacyTitle">‚ö†Ô∏è Privacy Note:</strong>
                    <span data-i18n="s4PrivacyText">Wills may become public records during probate. Consider:</span>
                </p>
                <ul class="text-blue-800 ml-4 mt-1 list-disc">
                    <li data-i18n="s4PrivacyPt1">Using partial identifiers (e.g. "Account ending in 1234")</li>
                    <li data-i18n="s4PrivacyPt2">Keeping full details in a separate private Asset Inventory document
                        that you give directly to your executor (not filed with the Will)</li>
                </ul>
            </div>

            <!-- PRIMARY ASSETS CARD -->
            <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all mb-6">
                <!-- Header -->
                <div class="bg-white p-4 border-b border-gray-100 flex items-center gap-3 select-none">
                    <div
                        class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-xl">
                        A</div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm" data-i18n="s4SpecificTitle">Specific Assets</h3>
                        <p class="text-xs text-gray-500" data-i18n="s4SpecificDesc">Add detailed assets (Flat, Bank A/C,
                            Insurance, etc.) here.</p>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-4 md:p-6 bg-slate-50">
                    <div id="asset-container" class="space-y-4 mb-4"></div>

                    <button onclick="addAssetRow()"
                        class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 hover:shadow-md transition flex items-center justify-center gap-2"
                        data-i18n="btnAddAsset">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        Add Another Asset
                    </button>
                </div>
            </div>

            <!-- RESIDUAL CLAUSE CARD (UNIFIED UI) -->
            <div
                class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all">
                <!-- Header -->
                <div class="bg-white p-4 border-b border-gray-100 flex justify-between items-center select-none">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 font-bold text-xl">
                            R</div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm" data-i18n="s4ResidualTitle">Residual Assets
                                (Everything Else)</h3>
                            <p class="text-xs text-gray-500" data-i18n="s4ResidualDesc">Covers assets not listed above
                                or future acquisitions.</p>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-4 md:p-6 bg-slate-50">
                    <div id="residual-shares-list" class="space-y-2"></div>

                    <button onclick="addResidualShare()"
                        class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 hover:shadow-md transition flex items-center justify-center gap-2 mt-4"
                        data-i18n="btnAddResidual">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        Add Residual Beneficiary
                    </button>
                </div>
            </div>

            <div class="flex justify-between pt-8">
                <button onclick="goToStep(3)" class="text-gray-500" data-i18n="btnBack">‚Üê Back</button>
                <button onclick="finishJourney()"
                    class="bg-green-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-green-700"
                    data-i18n="btnFinish">Finish &
                    Review</button>
            </div>
        </div>

        <!-- PREVIEW OVERLAY -->
        <div id="preview-overlay"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center overflow-y-auto py-10 backdrop-blur-sm fade-in"
            onclick="if(event.target === this) closePreview()">
            <div class="relative w-full max-w-[210mm] mx-auto">
                <button onclick="closePreview()"
                    class="fixed top-4 right-4 bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg hover:bg-gray-100 z-50 flex items-center gap-2"
                    data-i18n="btnClosePreview">
                    <span>‚úï</span> Close Preview
                </button>

                <div class="preview-paper" id="preview-content">
                    <!-- Content injected via JS -->
                </div>

                <div class="text-center mt-8 mb-10 text-white text-sm opacity-75" data-i18n="previewDisclaimer">
                    This is a preview. Final formatting may vary slightly in the PDF.
                </div>
            </div>
        </div>

        <!-- SUCCESS OVERLAY (UPDATED FOR DOWNLOAD OPTIONS) -->
        <div id="success-overlay" class="hidden bg-white z-50 p-6 rounded-lg text-center">
            <div class="max-w-2xl mx-auto pt-10">
                <div class="bg-green-100 p-4 rounded-full inline-block mb-4"><svg class="w-16 h-16 text-green-600"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg></div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="successTitle">Will Draft Ready!</h2>
                <p class="text-gray-600 mb-6" data-i18n="successSubtitle">Choose a format to download your Will.</p>

                <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
                    <button onclick="generatePDF()" id="btn-download-pdf"
                        class="flex items-center justify-center gap-2 bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-red-700 transition transform hover:-translate-y-1"
                        data-i18n="btnDownloadPDF">
                        <span class="text-xl">üìÑ</span> Download PDF
                    </button>
                    <button onclick="generateRTF()"
                        class="flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition transform hover:-translate-y-1"
                        data-i18n="btnDownloadRTF">
                        <span class="text-xl">üìù</span> Download Editable (.rtf)
                    </button>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-left space-y-4 shadow-sm">
                    <h3 class="text-xl font-bold text-blue-900 border-b border-blue-200 pb-2"
                        data-i18n="nextStepsTitle">üìã Critical Next Steps
                    </h3>
                    <div class="flex gap-4">
                        <div class="bg-white p-2 rounded text-2xl">üñ®Ô∏è</div>
                        <div>
                            <h4 class="font-bold text-gray-800" data-i18n="nsPrintTitle">Print</h4>
                            <p class="text-sm text-gray-600" data-i18n="nsPrintText">Print on high-quality A4 paper.
                                Digital signatures are NOT valid for Wills in India.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-white p-2 rounded text-2xl">‚úçÔ∏è</div>
                        <div>
                            <h4 class="font-bold text-gray-800" data-i18n="nsSignTitle">Sign Every Page</h4>
                            <p class="text-sm text-gray-600" data-i18n="nsSignText">To prevent tampering or page
                                swapping, You and your two witnesses must sign the bottom of every single page. A Will
                                without signatures on all pages can be challenged in court.</p>
                            <p class="text-xs text-red-600 mt-1 font-bold" data-i18n="nsSignReminder">REMINDER:
                                Beneficiaries must NOT sign the Will.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-white p-2 rounded text-2xl">üîê</div>
                        <div>
                            <h4 class="font-bold text-gray-800" data-i18n="nsSafeTitle">Safe Storage</h4>
                            <p class="text-sm text-gray-600" data-i18n="nsSafeText">Store safely and tell your Executor
                                where it is.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-white p-2 rounded text-2xl">üìπ</div>
                        <div>
                            <h4 class="font-bold text-gray-800" data-i18n="nsVideoTitle">Record a Video Will (Pro Tip)
                            </h4>
                            <p class="text-sm text-gray-600" data-i18n="nsVideoText">Record a video on your phone while
                                signing. Read the Will aloud to prove sound mind.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-white p-2 rounded text-2xl">üèõÔ∏è</div>
                        <div>
                            <h4 class="font-bold text-gray-800">Register (Optional)</h4>
                            <p class="text-sm text-gray-600">Register at Sub-Registrar office to prevent disputes.</p>
                        </div>
                    </div>
                </div>
                <button onclick="goHome()"
                    class="mt-10 text-indigo-600 font-semibold underline hover:text-indigo-800">Back to Home</button>
            </div>
        </div>

    </main>

    <!-- CUSTOM WARNING MODAL -->
    <div id="custom-warning-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="flex items-start gap-4">
                <div class="bg-yellow-100 p-2 rounded-full flex-shrink-0">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                </div>
                <div>
                    <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2">Warning Title</h3>
                    <p id="modal-message" class="text-sm text-gray-600 mb-4 leading-relaxed">Warning Message goes
                        here...</p>

                    <div id="modal-checkbox-container"
                        class="hidden flex items-center gap-2 mb-4 bg-gray-50 p-2 rounded border border-gray-100">
                        <input type="checkbox" id="modal-dont-show"
                            class="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4">
                        <label for="modal-dont-show"
                            class="text-xs font-medium text-gray-500 select-none cursor-pointer"
                            data-i18n="lblDontShow">Don't show this warning
                            again for beneficiaries</label>
                    </div>

                    <div class="flex gap-3 justify-end mt-2">
                        <button onclick="closeWarningModal()"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 text-sm font-bold hover:bg-gray-50 transition"
                            data-i18n="btnGoBack">Go
                            Back</button>
                        <button onclick="confirmWarningModal()"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-bold hover:bg-indigo-700 shadow transition"
                            data-i18n="btnProceed">Proceed
                            Anyway</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSET BOTTOM SHEET (Mobile Only) -->
    <div id="asset-bottom-sheet" class="hidden fixed inset-0 z-50">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 transition-opacity" onclick="closeAssetSheet()"></div>

        <!-- Bottom Sheet Container -->
        <div id="asset-sheet-container"
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl max-h-[90vh] flex flex-col transform transition-transform duration-300">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                <button onclick="closeAssetSheet()" class="text-gray-600 hover:text-gray-800 p-2 -ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="asset-sheet-title" class="text-lg font-bold text-gray-800">New Asset</h2>
                <div class="w-10"></div> <!-- Spacer for centering -->
            </div>

            <!-- Scrollable Content -->
            <div id="asset-sheet-content" class="flex-1 overflow-y-auto p-4">
                <!-- Content will be dynamically populated -->
            </div>

            <!-- Footer with Save Button -->
            <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                <button onclick="saveAssetSheet()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <!-- BENEFICIARY BOTTOM SHEET (Mobile Only) -->
    <div id="ben-bottom-sheet" class="hidden fixed inset-0 z-50">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 transition-opacity" onclick="closeBenSheet()"></div>

        <!-- Bottom Sheet Container -->
        <div id="ben-sheet-container"
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl max-h-[90vh] flex flex-col transform transition-transform duration-300">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                <button onclick="closeBenSheet()" class="text-gray-600 hover:text-gray-800 p-2 -ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="ben-sheet-title" class="text-lg font-bold text-gray-800">New Beneficiary</h2>
                <div class="w-10"></div> <!-- Spacer for centering -->
            </div>

            <!-- Scrollable Content -->
            <div id="ben-sheet-content" class="flex-1 overflow-y-auto p-4">
                <!-- Content will be dynamically populated -->
            </div>

            <!-- Footer with Save Button -->
            <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                <button onclick="saveBenSheet()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <!-- RESIDUAL BOTTOM SHEET (Mobile Only) -->
    <div id="residual-bottom-sheet" class="hidden fixed inset-0 z-50">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 transition-opacity" onclick="closeResidualSheet()"></div>

        <!-- Bottom Sheet Container -->
        <div id="residual-sheet-container"
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl max-h-[90vh] flex flex-col transform transition-transform duration-300">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                <button onclick="closeResidualSheet()" class="text-gray-600 hover:text-gray-800 p-2 -ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="residual-sheet-title" class="text-lg font-bold text-gray-800">Residual Beneficiary</h2>
                <div class="w-10"></div> <!-- Spacer for centering -->
            </div>

            <!-- Scrollable Content -->
            <div id="residual-sheet-content" class="flex-1 overflow-y-auto p-4">
                <!-- Content will be dynamically populated -->
            </div>

            <!-- Footer with Save Button -->
            <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                <button onclick="saveResidualSheet()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <script src="translations.js"></script>
    <script>
        let beneficiaries = [];
        let executors = [];
        let executorCount = 0;
        let assetCount = 0;
        let beneficiaryCount = 0;
        let lastActiveStep = 0;
        let savedStepIndex = 1;
        let maxReachedStep = 0;
        let suppressBenWarning = false;
        let currentModalCallback = null;
        let saveTimeout = null;
        const STORAGE_KEY = 'sahayWillDataV30';

        const ASSET_ICONS = {
            'flat': 'üè†', 'land': 'üå≥', 'shop': 'üè¢',
            'savings': 'üè¶', 'fd': 'üìú', 'locker': 'üîê', 'loan': 'ü§ù',
            'nps': 'üë¥', 'mf': 'üìà', 'demat': 'üìä', 'crypto': '‚Çø', 'insurance': 'üõ°Ô∏è',
            'esop': 'üíº', 'business': 'üè≠',
            'vehicle': 'üöó', 'jewelry': 'üíç'
        };

        const ASSET_SCHEMAS = {
            'flat': [
                { key: 'addr', label: 'Complete Property Address (incl. Pin Code)', type: 'textarea' },
                { key: 'survey', label: 'Survey/Khata/Deed No. (optional)', type: 'text' }
            ],
            'land': [
                { key: 'addr', label: 'Location / Village / Taluk', type: 'text' },
                { key: 'survey', label: 'Survey Number (optional)', type: 'text' }
            ],
            'shop': [
                { key: 'addr', label: 'Shop/Office Address', type: 'textarea' },
                { key: 'reg', label: 'Registration details (optional)', type: 'text' }
            ],
            'savings': [
                { key: 'bank', label: 'Bank Name & Branch', type: 'text' },
                { key: 'acc_no', label: 'Account ending in (last 4 digits)', type: 'text' },
                { key: 'ifsc', label: 'Branch Name / IFSC (Optional)', type: 'text' }
            ],
            'fd': [
                { key: 'bank', label: 'Bank / Post Office Name', type: 'text' },
                { key: 'fd_no', label: 'Last 4 digits of FD number', type: 'text' }
            ],
            'locker': [
                { key: 'bank', label: 'Bank Name & Branch', type: 'text' },
                { key: 'locker_no', label: 'Locker number (optional)', type: 'text' }
            ],
            'nps': [
                { key: 'pran', label: 'Last 4 digits of PRAN/UAN/PPO', type: 'text' }
            ],
            'esop': [
                { key: 'company', label: 'Company Name', type: 'text' },
                { key: 'units', label: 'Grant year or last 4 digits', type: 'textarea' }
            ],
            'business': [
                { key: 'name', label: 'Business Name', type: 'text' },
                { key: 'structure', label: 'Structure (Proprietorship / Partnership / Pvt Ltd)', type: 'text' },
                { key: 'share', label: 'Registration details (optional)', type: 'text' }
            ],
            'mf': [
                { key: 'fund', label: 'AMC Name (e.g. SBI Mutual Fund)', type: 'text' },
                { key: 'folio', label: 'Last 4 digits of folio number', type: 'text' },
                { key: 'specific_holding', label: 'Specific Scheme (Optional - Leave blank for all schemes in folio)', type: 'text' }
            ],
            'demat': [
                { key: 'broker', label: 'Broker Name (e.g. Zerodha, Groww)', type: 'text' },
                { key: 'dpid', label: 'Last 4 digits of Client ID', type: 'text' },
                { key: 'specific_holding', label: 'Specific Stock/ISIN (Optional - Leave blank for entire account)', type: 'text' }
            ],
            'crypto': [
                { key: 'exchange', label: 'Exchange/Wallet Name', type: 'text' },
                { key: 'identifier', label: 'Last 4 characters of wallet ID', type: 'text' },
                { key: 'specific_holding', label: 'Specific Coin/Token (Optional - Leave blank for whole wallet)', type: 'text' }
            ],
            'insurance': [
                { key: 'insurer', label: 'Insurance Company', type: 'text' },
                { key: 'policy', label: 'Last 4 digits of policy number', type: 'text' }
            ],
            'loan': [
                { key: 'borrower', label: 'Borrower Name (Who owes you money?)', type: 'text' },
                { key: 'amount', label: 'Amount Owed (Approx)', type: 'text' },
                { key: 'date', label: 'Loan date or last 4 digits', type: 'text' }
            ],
            'vehicle': [
                { key: 'model', label: 'Vehicle Make & Model (e.g. Honda City)', type: 'text' },
                { key: 'reg', label: 'Last 4 digits of registration', type: 'text' }
            ],
            'jewelry': [
                { key: 'desc', label: 'Description (Weight, Metal, Distinctive marks)', type: 'textarea' },
                { key: 'loc', label: 'Location (Where is it kept?)', type: 'text' }
            ]
        };

        // --- UTILS ---
        let globalIdCounter = 0;
        function generateUniqueId() {
            return String(Date.now()) + String(globalIdCounter++).padStart(3, '0');
        }

        function escapeHtml(text) {
            if (!text) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.removeSpecificRow = function (uniqueId) {
            if (confirm(TRANSLATIONS[currentLang].confirmDeleteAsset)) {
                const el = document.getElementById('asset-row-' + uniqueId);
                if (el) { el.remove(); saveData(); }
            }
        };

        window.removeBeneficiaryRow = function (uniqueId) {
            if (confirm(TRANSLATIONS[currentLang].confirmDeleteBen)) {
                const el = document.getElementById('ben-row-' + uniqueId);
                if (el) { el.remove(); saveData(); }
            }
        };

        // --- Multiple Executors Functions ---

        function addExecutorRow(isPrimary = true) {
            executorCount++;
            const executor = {
                id: executorCount,
                name: '',
                relationship: '',
                address: '',
                parentName: '',
                isPrimary: isPrimary
            };
            executors.push(executor);
            renderExecutorRow(executor);
            renderExecutorSummaryCard(); // Update mobile summary
            saveData();
        }

        function renderExecutorRow(executor) {
            const container = executor.isPrimary
                ? document.getElementById('primary-executors-container')
                : document.getElementById('alternate-executor-container');

            if (!container) return; // Safety check

            const t = TRANSLATIONS[currentLang];
            const primaryCount = executors.filter(e => e.isPrimary && e.id <= executor.id).length;
            const label = executor.isPrimary
                ? `${t.s2ExecutorNum} ${primaryCount}`
                : t.s2AlternateExecutor;

            // Split parent name if needed
            let relPrefix = 'S/o';
            let parentNameOnly = executor.parentName;
            if (executor.parentName) {
                const parts = executor.parentName.split(' ');
                if (['S/o', 'D/o', 'W/o'].includes(parts[0])) {
                    relPrefix = parts[0];
                    parentNameOnly = parts.slice(1).join(' ');
                }
            }

            const html = `
                <div id="executor-row-${executor.id}" class="executor-item border rounded-lg bg-white shadow-sm mb-3 overflow-hidden">
                    <!-- Header (Always Visible) -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer" onclick="toggleExecutorRow(${executor.id})">
                        <div class="flex items-center gap-3">
                            <div class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                ${executor.isPrimary ? primaryCount : 'A'}
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">${executor.name || label}</h4>
                                <p class="text-xs text-gray-500">${executor.relationship || t.lblExRel}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); toggleExecutorRow(${executor.id})" class="text-indigo-600 text-sm font-semibold hover:underline">
                                ${t.btnEditExecutor || 'Edit'}
                            </button>
                            <button onclick="event.stopPropagation(); removeExecutorRow(${executor.id})" class="text-red-500 hover:text-red-700 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Body (Collapsible) -->
                    <div id="executor-body-${executor.id}" class="p-4 border-t ${executor.name ? 'hidden' : ''}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500">${t.lblExName} <span class="text-red-500">*</span></label>
                                <input type="text" id="ex-name-${executor.id}"
                                    class="w-full border p-3 rounded"
                                    placeholder="${t.phExName}"
                                    value="${executor.name}"
                                    oninput="updateExecutorHeader(${executor.id}); saveData()">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500">${t.lblExRel} <span class="text-red-500">*</span></label>
                                <input type="text" id="ex-rel-${executor.id}"
                                    class="w-full border p-3 rounded"
                                    placeholder="${t.phExRel}"
                                    value="${executor.relationship}"
                                    oninput="updateExecutorHeader(${executor.id}); saveData()">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs font-bold text-gray-500">${t.lblExAddress}</label>
                                <textarea id="ex-address-${executor.id}"
                                    class="w-full border p-3 rounded"
                                    rows="2"
                                    placeholder="${t.phExAddress}"
                                    oninput="saveData()">${executor.address}</textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs font-bold text-gray-500">${t.lblExParentName}</label>
                                <div class="flex gap-2">
                                    <select id="ex-prefix-${executor.id}" onchange="saveData()" class="w-24 border p-3 rounded bg-white text-sm">
                                        <option value="S/o" ${relPrefix === 'S/o' ? 'selected' : ''}>${t.optSonOf || 'S/o'}</option>
                                        <option value="D/o" ${relPrefix === 'D/o' ? 'selected' : ''}>${t.optDaughterOf || 'D/o'}</option>
                                        <option value="W/o" ${relPrefix === 'W/o' ? 'selected' : ''}>${t.optWifeOf || 'W/o'}</option>
                                    </select>
                                    <input type="text" id="ex-parent-${executor.id}"
                                        class="w-full border p-3 rounded"
                                        placeholder="Parent/Spouse Name"
                                        value="${parentNameOnly || ''}"
                                        oninput="saveData()">
                            </div>
                        </div>
                    </div> <!-- End Grid -->
                    
                    <div class="text-center mt-6">
                        <button onclick="toggleExecutorRow(${executor.id})" class="text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 px-8 py-2 rounded shadow transition">
                            ${t.dynEdit === 'Edit' ? 'Done & Collapse' : '‡§™‡•Ç‡§∞‡•ç‡§£ ‡§î‡§∞ ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç'}
                        </button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);

            // Hide "Add Alternate" button if alternate exists
            if (!executor.isPrimary) {
                const btn = document.getElementById('btn-add-alternate');
                if (btn) btn.classList.add('hidden');
            }
        }

        // Toggle executor row expansion
        function toggleExecutorRow(id) {
            const body = document.getElementById(`executor-body-${id}`);
            if (body) {
                body.classList.toggle('hidden');
            }
        }

        // Update header text dynamically
        function updateExecutorHeader(id) {
            const name = document.getElementById(`ex-name-${id}`).value;
            const rel = document.getElementById(`ex-rel-${id}`).value;
            const row = document.getElementById(`executor-row-${id}`);
            const t = TRANSLATIONS[currentLang];

            if (row) {
                const title = row.querySelector('h4');
                const subtitle = row.querySelector('p');
                if (title) title.textContent = name || (row.id.includes('primary') ? t.s2ExecutorNum : t.s2AlternateExecutor);
                if (subtitle) subtitle.textContent = rel || t.lblExRel;
            }
        }

        function removeExecutorRow(executorId) {
            const executor = executors.find(e => e.id === executorId);
            if (!executor) return;

            executors = executors.filter(e => e.id !== executorId);
            const row = document.getElementById(`executor-row-${executorId}`);
            if (row) row.remove();

            if (!executor.isPrimary) {
                const btn = document.getElementById('btn-add-alternate');
                if (btn) btn.classList.remove('hidden');
            }

            renderExecutorSummaryCard(); // Update mobile summary
            saveData();
        }

        function collectExecutors() {
            console.log('[CollectExecutors] START');

            // Collect from desktop rows
            const desktopRows = document.querySelectorAll('.executor-item');
            console.log('[CollectExecutors] Found', desktopRows.length, 'desktop rows');

            desktopRows.forEach(row => {
                const id = parseInt(row.id.replace('executor-row-', ''));
                console.log('[CollectExecutors] Processing row with ID:', id);

                const executor = executors.find(e => e.id === id);
                console.log('[CollectExecutors] Found executor in array?', !!executor, executor);

                if (executor) {
                    const nameInput = document.getElementById(`ex-name-${id}`);
                    const relInput = document.getElementById(`ex-rel-${id}`);
                    const addrInput = document.getElementById(`ex-address-${id}`);
                    const prefixInput = document.getElementById(`ex-prefix-${id}`);
                    const parentInput = document.getElementById(`ex-parent-${id}`);

                    console.log('[CollectExecutors] Input elements found:', {
                        nameInput: !!nameInput,
                        relInput: !!relInput,
                        addrInput: !!addrInput
                    });

                    console.log('[CollectExecutors] Input VALUES:', {
                        nameValue: nameInput ? nameInput.value : 'N/A',
                        relValue: relInput ? relInput.value : 'N/A',
                        addrValue: addrInput ? addrInput.value : 'N/A'
                    });

                    console.log('[CollectExecutors] Executor BEFORE update:', JSON.stringify(executor));

                    if (nameInput) executor.name = nameInput.value.trim();
                    if (relInput) executor.relationship = relInput.value.trim();
                    if (addrInput) executor.address = addrInput.value.trim();

                    console.log('[CollectExecutors] Executor AFTER update:', JSON.stringify(executor));

                    // Combine prefix and parent name
                    if (prefixInput && parentInput) {
                        const prefix = prefixInput.value;
                        const parentName = parentInput.value.trim();
                        if (parentName) {
                            executor.parentName = `${prefix} ${parentName}`;
                        } else {
                            executor.parentName = '';
                        }
                    }
                }
            });

            // Collect from mobile summary cards (ONLY on mobile view)
            // On desktop, mobile cards may contain stale data that would overwrite desktop input values
            if (isMobile()) {
                document.querySelectorAll('.executor-summary-card').forEach(card => {
                    const id = parseInt(card.getAttribute('data-id'));
                    const dataDiv = card.querySelector('.executor-data');
                    if (dataDiv) {
                        const data = JSON.parse(dataDiv.getAttribute('data-json') || '{}');
                        const existingExecutor = executors.find(e => e.id === id);
                        if (existingExecutor) {
                            Object.assign(existingExecutor, data);
                        } else {
                            executors.push(data);
                        }
                    }
                });
            }

            return executors;
        }

        // --- MOBILE EXECUTOR SHEET FUNCTIONS ---
        let currentExecutorSheetId = null;
        let currentExecutorSheetIsPrimary = true;

        function renderExecutorSummaryCard() {
            const container = document.getElementById('mobile-executor-cards-container');
            if (!container) return;
            container.innerHTML = ''; // Clear existing cards

            const t = TRANSLATIONS[currentLang];

            const primary = executors.filter(e => e.isPrimary);
            const alternate = executors.find(e => !e.isPrimary);

            // Primary Executors Card
            let html = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all mb-6">
                    <!-- Header -->
                    <div class="bg-white p-4 border-b border-gray-100 flex items-center gap-3 select-none">
                        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xl">P</div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">${t.s2PrimaryExecutors}</h3>
                            <p class="text-xs text-gray-500">${t.s2TipMultiple}</p>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="p-4 bg-slate-50">
                        <div class="space-y-3 mb-4">
            `;

            primary.forEach((ex, idx) => {
                html += `
                    <div id="executor-summary-card-${ex.id}" class="executor-summary-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm cursor-pointer" onclick="openExecutorSheet(${ex.id}, true)" data-id="${ex.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">${idx + 1}</div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-sm">${ex.name || t.s2ExecutorNum + ' ' + (idx + 1)}</h3>
                                    <p class="text-xs text-gray-500">${ex.relationship || t.lblExRel}</p>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); removeExecutorRow(${ex.id})" class="text-red-500 hover:text-red-700 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                        <div class="hidden executor-data" data-json='${JSON.stringify(ex)}'></div>
                    </div>
                `;
            });

            html += `
                        </div>
                        <button onclick="openExecutorSheet(null, true)"
                            class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 transition flex items-center justify-center gap-2"
                            data-i18n="s2AddPrimary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            ${t.s2AddPrimary}
                        </button>
                    </div>
                </div>
            `;

            // Alternate Executor Card
            html += `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ring-2 ring-transparent hover:ring-indigo-50 transition-all">
                    <!-- Header -->
                    <div class="bg-white p-4 border-b border-gray-100 flex items-center gap-3 select-none">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 font-bold text-xl">A</div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">${t.s2AlternateSection}</h3>
                            <p class="text-xs text-gray-500">${t.s2AlternateInfo}</p>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="p-4 bg-slate-50">
                        <div class="mb-4">
            `;

            if (alternate) {
                html += `
                    <div id="executor-summary-card-${alternate.id}" class="executor-summary-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm cursor-pointer" onclick="openExecutorSheet(${alternate.id}, false)" data-id="${alternate.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="bg-gray-100 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">A</div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-gray-800 text-sm">${alternate.name || t.s2AlternateExecutor}</h3>
                                    </div>
                                    <p class="text-xs text-gray-500">${alternate.relationship || t.lblExRel}</p>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); removeExecutorRow(${alternate.id})" class="text-red-500 hover:text-red-700 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                        <div class="hidden executor-data" data-json='${JSON.stringify(alternate)}'></div>
                    </div>
                `;
            }

            html += `
                        </div>
            `;

            if (!alternate) {
                html += `
                        <button id="mobile-btn-add-alternate" onclick="openExecutorSheet(null, false)"
                            class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 font-semibold rounded hover:bg-indigo-50 transition flex items-center justify-center gap-2"
                            data-i18n="s2AddAlternate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            ${t.s2AddAlternate}
                        </button>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function openExecutorSheet(executorId = null, isPrimary = true) {
            currentExecutorSheetId = executorId;
            currentExecutorSheetIsPrimary = isPrimary;

            const sheet = document.getElementById('executor-sheet');
            const container = document.getElementById('executor-sheet'); // It's the same element for the sheet and container
            const titleEl = document.getElementById('sheet-executor-title');
            const t = TRANSLATIONS[currentLang];

            let executorData = {
                name: '',
                relationship: '',
                address: '',
                parentName: '',
                isPrimary: isPrimary
            };

            if (executorId) {
                const existingExecutor = executors.find(e => e.id === executorId);
                if (existingExecutor) {
                    executorData = { ...existingExecutor };
                }
                titleEl.textContent = t.sheetEditExecutor;
            } else {
                titleEl.textContent = isPrimary ? t.sheetAddPrimary : t.sheetAddAlternate;
            }

            // Populate form fields
            document.getElementById('sheet-ex-name').value = executorData.name;
            document.getElementById('sheet-ex-rel').value = executorData.relationship;
            document.getElementById('sheet-ex-address').value = executorData.address;

            // Handle parentName (prefix + name)
            let parentNameOnly = '';
            let prefix = 'S/o';
            if (executorData.parentName) {
                const parts = executorData.parentName.split(' ');
                if (['S/o', 'D/o', 'W/o'].includes(parts[0])) {
                    prefix = parts[0];
                    parentNameOnly = parts.slice(1).join(' ');
                } else {
                    parentNameOnly = executorData.parentName; // Fallback if no prefix
                }
            }
            document.getElementById('sheet-ex-parent').value = parentNameOnly;
            document.getElementById('sheet-ex-prefix').value = prefix;

            sheet.classList.remove('hidden');
            setTimeout(() => {
                container.classList.remove('translate-y-full');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeExecutorSheet() {
            const sheet = document.getElementById('executor-sheet');
            const container = document.getElementById('executor-sheet');

            container.classList.add('translate-y-full');
            setTimeout(() => {
                sheet.classList.add('hidden');
                document.body.style.overflow = 'auto';
                currentExecutorSheetId = null;
            }, 300);
        }

        function saveExecutorSheet() {
            const t = TRANSLATIONS[currentLang];
            const name = document.getElementById('sheet-ex-name').value.trim();
            const relationship = document.getElementById('sheet-ex-rel').value.trim();
            const address = document.getElementById('sheet-ex-address').value.trim();
            const parentNameInput = document.getElementById('sheet-ex-parent').value.trim();
            const prefix = document.getElementById('sheet-ex-prefix').value;

            let parentName = '';
            if (parentNameInput) {
                parentName = `${prefix} ${parentNameInput}`;
            }

            if (!name || !relationship) {
                alert(t.alertExecutorRequired);
                return;
            }

            let executor = null;
            if (currentExecutorSheetId) {
                executor = executors.find(e => e.id === currentExecutorSheetId);
            }

            if (executor) {
                // Update existing executor
                executor.name = name;
                executor.relationship = relationship;
                executor.address = address;
                executor.parentName = parentName;
                executor.isPrimary = currentExecutorSheetIsPrimary; // Ensure primary status is maintained
            } else {
                // Add new executor
                executorCount++;
                executor = {
                    id: executorCount,
                    name: name,
                    relationship: relationship,
                    address: address,
                    parentName: parentName,
                    isPrimary: currentExecutorSheetIsPrimary
                };
                executors.push(executor);
            }

            renderDesktopExecutors(); // Re-render desktop view to reflect changes
            renderExecutorSummaryCard(); // Re-render mobile summary cards
            saveData();
            closeExecutorSheet();
        }

        function deleteExecutorFromSheet() {
            if (currentExecutorSheetId && confirm(TRANSLATIONS[currentLang].confirmDeleteExecutor)) {
                removeExecutorRow(currentExecutorSheetId);
                closeExecutorSheet();
            }
        }

        function renderDesktopExecutors() {
            const pContainer = document.getElementById('primary-executors-container');
            const aContainer = document.getElementById('alternate-executor-container');
            if (pContainer) pContainer.innerHTML = '';
            if (aContainer) aContainer.innerHTML = '';

            executors.sort((a, b) => a.id - b.id); // Maintain order
            executors.forEach(ex => {
                renderExecutorRow(ex);
            });

            // Update Add Alternate Button visibility
            const hasAlternate = executors.some(e => !e.isPrimary);
            const btnAddAlt = document.getElementById('btn-add-alternate');
            if (btnAddAlt) {
                if (hasAlternate) btnAddAlt.classList.add('hidden');
                else btnAddAlt.classList.remove('hidden');
            }
        }

        function renderSheetExecutorList() {
            // This function is no longer needed as the sheet is for a single executor
            // The mobile summary cards are rendered by renderExecutorSummaryCard()
        }

        function validateAndMoveToBeneficiaries() {
            console.log('[ValidateAndMove] Starting validation');
            console.log('[ValidateAndMove] Executors before collectExecutors:', executors);

            collectExecutors();

            console.log('[ValidateAndMove] Executors after collectExecutors:', executors);

            const primaryExecutors = executors.filter(e => e.isPrimary);
            console.log('[ValidateAndMove] Primary executors:', primaryExecutors);

            if (primaryExecutors.length === 0) {
                alert(t.errPrimaryExReq || "Please add at least one Primary Executor.");
                return;
            }

            let isValid = true;
            executors.forEach(ex => {
                // Check if executor is completely untouched (all fields empty)
                const isCompletelyEmpty = !ex.name && !ex.relationship && !ex.address && !ex.parentName;

                console.log('[ValidateAndMove] Executor', ex.id, '- isEmpty:', isCompletelyEmpty, 'name:', ex.name, 'rel:', ex.relationship);

                if (isCompletelyEmpty) {
                    // Skip validation for completely empty executors (placeholder rows)
                    console.log('[ValidateAndMove] Skipping empty executor', ex.id);
                    return;
                }

                // If executor has been started (at least one field filled), validate required fields
                if (!ex.name || !ex.relationship) {
                    console.log('[ValidateAndMove] VALIDATION FAILED for executor', ex.id);
                    isValid = false;
                    // Expand the row with error for desktop
                    const body = document.getElementById(`executor-body-${ex.id}`);
                    if (body && body.classList.contains('hidden')) {
                        toggleExecutorRow(ex.id);
                    }
                    // Highlight empty fields for desktop
                    const nameInput = document.getElementById(`ex-name-${ex.id}`);
                    const relInput = document.getElementById(`ex-rel-${ex.id}`);
                    if (nameInput && !nameInput.value) nameInput.classList.add('border-red-500');
                    if (relInput && !relInput.value) relInput.classList.add('border-red-500');

                    // For mobile, we can't highlight directly, but the sheet will show the error
                }
            });

            console.log('[ValidateAndMove] Final isValid:', isValid);

            if (!isValid) {
                const t = TRANSLATIONS[currentLang];
                alert(t.errExFields || "Please fill in Name and Relationship for all executors.");
                return;
            }

            updateMaxReached(3);
            goToStep(3);
        }

        function initApp() {
            loadData();
            // Restore language preference if saved separately (e.g., after starting fresh)
            const savedLangPref = localStorage.getItem('SAHAY_LANG_PREF');
            if (savedLangPref && (savedLangPref === 'en' || savedLangPref === 'hi')) {
                currentLang = savedLangPref;
                localStorage.removeItem('SAHAY_LANG_PREF'); // Clear the flag after using it
            }
            // Restore language preference if saved
            updateLanguage();
            // Initialize mobile executor summary card (this may hide the button)
            renderExecutorSummaryCard();
            // Force button visibility after renderExecutorSummaryCard (to override any hiding)
            const hasAlternate = executors.some(e => !e.isPrimary);
            const btnAddAlt = document.getElementById('btn-add-alternate');
            const mobileBtnAddAlt = document.getElementById('mobile-btn-add-alternate');

            console.log('InitApp - Has alternate executor:', hasAlternate);
            console.log('InitApp - Mobile button exists:', !!mobileBtnAddAlt);

            // Desktop button
            if (btnAddAlt) {
                if (hasAlternate) {
                    btnAddAlt.classList.add('hidden');
                } else {
                    btnAddAlt.classList.remove('hidden');
                }
            }

            // Mobile button - aggressively ensure it's visible if no alternate
            if (mobileBtnAddAlt) {
                if (hasAlternate) {
                    mobileBtnAddAlt.classList.add('hidden');
                    mobileBtnAddAlt.style.display = 'none';
                } else {
                    mobileBtnAddAlt.classList.remove('hidden');
                    mobileBtnAddAlt.style.display = '';
                    console.log('InitApp - Mobile button should now be visible');
                }
            }

            // Check if auto-start flag is set (from startFresh)
            if (sessionStorage.getItem('SAHAY_AUTO_START') === 'true') {
                sessionStorage.removeItem('SAHAY_AUTO_START');
                goToStep(1);
            } else {
                // Check URL hash for step navigation
                const hash = window.location.hash.substring(1);
                const stepMap = { 'welcome': 0, 'you': 1, 'executor': 2, 'heirs': 3, 'assets': 4, 'generate': 5 };
                if (hash && stepMap[hash] !== undefined) {
                    goToStep(stepMap[hash], true); // Skip history to avoid duplicate entry
                } else {
                    // Initialize history with current step
                    const currentStep = lastActiveStep || 0;
                    const stepName = ['welcome', 'you', 'executor', 'heirs', 'assets', 'generate'][currentStep] || 'welcome';
                    history.replaceState({ step: currentStep }, '', `#${stepName}`);
                }
            }
        }

        // Handle browser back/forward buttons
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            // Check for open sheets and close them (UI only)
            const benSheet = document.getElementById('ben-bottom-sheet');
            if (benSheet && !benSheet.classList.contains('hidden')) {
                _closeBenSheetUI();
                return;
            }

            const residualSheet = document.getElementById('residual-bottom-sheet');
            if (residualSheet && !residualSheet.classList.contains('hidden')) {
                _closeResidualSheetUI();
                return;
            }

            const assetSheet = document.getElementById('asset-bottom-sheet');
            if (assetSheet && !assetSheet.classList.contains('hidden')) {
                _closeAssetSheetUI();
                return;
            }

            if (event.state && event.state.step !== undefined) {
                if (event.state.step !== lastActiveStep) {
                    goToStep(event.state.step, true); // Skip history to avoid duplicate entry
                }
            }
        });

        function startFresh() {
            const t = TRANSLATIONS[currentLang];
            showCustomWarning(
                t.warnDeleteDraftTitle,
                t.warnDeleteDraftMsg,
                false,
                () => {
                    // Save current language before clearing data
                    const savedLang = currentLang;
                    localStorage.removeItem(STORAGE_KEY);
                    // Restore language preference
                    localStorage.setItem('SAHAY_LANG_PREF', savedLang);
                    // Set flag so initApp knows to jump to Step 1 after reload
                    sessionStorage.setItem('SAHAY_AUTO_START', 'true');
                    location.reload();
                }
            );
        }

        function updateProgressBar(step) {
            const totalNodes = 6;
            const progressPercent = (step / (totalNodes - 1)) * 100;
            document.getElementById('stepper-line').style.width = progressPercent + '%';

            for (let i = 0; i < totalNodes; i++) {
                const node = document.getElementById(`step-node-${i}`);
                if (!node) continue;
                const circle = node.querySelector('.step-circle');
                const label = node.querySelector('span');

                circle.className = 'step-circle w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold transition-all duration-300';
                label.className = 'absolute top-full left-1/2 -translate-x-1/2 w-max text-[10px] mt-1 font-medium transition-colors duration-300';

                if (i < step) {
                    circle.classList.add('bg-green-600', 'border-green-600', 'text-white');
                    circle.innerHTML = '‚úì';
                    label.classList.add('text-green-500');
                } else if (i === step) {
                    circle.classList.add('bg-white', 'border-white', 'text-indigo-900', 'scale-110', 'shadow-lg');
                    circle.innerHTML = i + 1;
                    label.classList.add('text-white', 'font-bold');
                } else {
                    circle.classList.add('bg-indigo-900', 'border-indigo-500', 'text-indigo-400');
                    circle.innerHTML = i + 1;
                    label.classList.add('text-indigo-400');
                }
            }
        }

        function checkDraftStatus() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                document.getElementById('resume-banner').classList.add('hidden');
                document.getElementById('start-btn-container').style.display = '';
                return;
            }

            try {
                const data = JSON.parse(raw);
                const hasData = data.myName ||
                    (data.beneficiaries && data.beneficiaries.length > 0) ||
                    (data.assets && data.assets.length > 0);

                if (hasData) {
                    document.getElementById('resume-banner').classList.remove('hidden');
                    document.getElementById('start-btn-container').style.display = 'none';
                } else {
                    document.getElementById('resume-banner').classList.add('hidden');
                    document.getElementById('start-btn-container').style.display = '';
                }
            } catch (e) {
                console.error('Error checking draft status:', e);
                document.getElementById('resume-banner').classList.add('hidden');
                document.getElementById('start-btn-container').style.display = '';
            }
        }

        function goToStep(step, skipHistory = false) {
            lastActiveStep = step;
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));

            if (step === 0) {
                checkDraftStatus();
            }

            if (step === 5) {
                document.getElementById('success-overlay').classList.remove('hidden');
                document.getElementById('preview-overlay').classList.add('hidden');
            } else {
                document.getElementById(`step-${step}`).classList.add('active');
                document.getElementById('preview-overlay').classList.add('hidden');
                document.getElementById('success-overlay').classList.add('hidden');
            }

            updateProgressBar(step);
            window.scrollTo(0, 0);

            // Update browser history so back button works correctly on mobile
            if (!skipHistory) {
                const stepName = ['welcome', 'you', 'executor', 'heirs', 'assets', 'generate'][step] || 'step';
                history.pushState({ step: step }, '', `#${stepName}`);
            }
        }

        function navigateToStep(step) {
            if (step <= maxReachedStep) {
                goToStep(step);
            }
        }

        function updateMaxReached(step) {
            if (step > maxReachedStep) maxReachedStep = step;
        }

        function resumeJourney() { goToStep(savedStepIndex); }
        function goHome() { document.getElementById('success-overlay').classList.add('hidden'); document.getElementById('preview-overlay').classList.add('hidden'); goToStep(0); }
        function removeError(input) { input.classList.remove('error-border'); }

        function checkReligion() {
            const rel = document.getElementById('religionSelector').value;
            document.getElementById('muslim-warning').classList.toggle('hidden', rel !== 'Muslim');
            document.getElementById('hindu-warning').classList.toggle('hidden', rel !== 'Hindu');
            document.getElementById('other-religion-wrapper').classList.toggle('hidden', rel !== 'Other');
        }

        // --- CUSTOM MODAL LOGIC ---
        function showCustomWarning(title, message, isBeneficiaryStep, callback) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;

            const checkboxContainer = document.getElementById('modal-checkbox-container');
            if (isBeneficiaryStep) {
                checkboxContainer.classList.remove('hidden');
                document.getElementById('modal-dont-show').checked = false;
            } else {
                checkboxContainer.classList.add('hidden');
            }
            currentModalCallback = callback;
            document.getElementById('custom-warning-modal').classList.remove('hidden');
        }
        function closeWarningModal() { document.getElementById('custom-warning-modal').classList.add('hidden'); currentModalCallback = null; }
        function confirmWarningModal() {
            const checkbox = document.getElementById('modal-dont-show');
            if (!document.getElementById('modal-checkbox-container').classList.contains('hidden') && checkbox.checked) suppressBenWarning = true;
            if (currentModalCallback) currentModalCallback();
            closeWarningModal();
        }

        function validateAndNext(currentStep, nextStep) {
            const stepDiv = document.getElementById(`step-${currentStep}`);
            const requiredInputs = stepDiv.querySelectorAll('.required-field');
            let isValid = true;
            requiredInputs.forEach(input => {
                if (!input.value.trim()) { input.classList.add('error-border'); isValid = false; }
                else { input.classList.remove('error-border'); }
            });

            if (currentStep === 1 && document.getElementById('religionSelector').value === 'Other') {
                const otherInput = document.getElementById('customReligion');
                if (!otherInput.value.trim()) { otherInput.classList.add('error-border'); isValid = false; }
                else { otherInput.classList.remove('error-border'); }
            }

            if (!isValid) {
                alert(t.errMandatory || "Please fill in all mandatory fields highlighted in red.");
                return;
            }
            updateMaxReached(nextStep);
            goToStep(nextStep);
        }

        // --- PREVIEW LOGIC ---
        function openPreview() {
            performSave(); // Force save to update beneficiaries array
            renderPreview();
            document.getElementById('preview-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closePreview() {
            document.getElementById('preview-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // --- HELPER: Collect Assets from Both Mobile and Desktop Views ---
        function collectAllAssets() {
            const assets = [];

            // 1. Desktop Accordions
            document.querySelectorAll('.asset-item').forEach(row => {
                const shares = [];
                row.querySelectorAll('.share-row').forEach(sr => {
                    const benId = sr.querySelector('.ben-select-share')?.value;
                    const share = sr.querySelector('.share-input')?.value;
                    const altId = sr.querySelector('.ben-select-alt-share')?.value;
                    if (benId) {
                        shares.push({ benId, share, altId });
                    }
                });

                const details = {};
                row.querySelectorAll('.dynamic-field-input').forEach(inp => {
                    const key = inp.getAttribute('data-key');
                    if (inp.value) {
                        details[key] = inp.value;
                    }
                });

                const typeSelect = row.querySelector('.asset-type-select');
                if (typeSelect && typeSelect.value) {
                    assets.push({
                        type: typeSelect.value,
                        details: details,
                        shares: shares
                    });
                }
            });

            // 2. Mobile Summary Cards
            document.querySelectorAll('.asset-summary-card').forEach(card => {
                const type = card.getAttribute('data-type');
                if (!type) return;

                const benData = card.querySelector('.asset-data');
                let shares = [];
                if (benData) {
                    const rawBens = JSON.parse(benData.getAttribute('data-beneficiaries') || '[]');
                    shares = rawBens.map(b => ({
                        benId: b.benId,
                        share: b.share,
                        altId: b.altId
                    }));
                }

                const fieldsData = card.querySelector('.asset-fields-data');
                let details = {};
                if (fieldsData) {
                    details = JSON.parse(fieldsData.getAttribute('data-fields') || '{}');
                }

                assets.push({
                    type: type,
                    details: details,
                    shares: shares
                });
            });

            return assets;
        }

        function collectResidualShares() {
            const shares = [];
            // 1. Desktop Residual Rows
            document.querySelectorAll('.residual-row').forEach(row => {
                shares.push({
                    benId: row.querySelector('.residual-ben-select').value,
                    share: row.querySelector('.residual-share-input').value,
                    altId: row.querySelector('.residual-ben-alt-select').value
                });
            });

            // 2. Mobile Residual Summary Cards
            document.querySelectorAll('.residual-summary-card').forEach(card => {
                const dataDiv = card.querySelector('.residual-data');
                if (dataDiv) {
                    const data = JSON.parse(dataDiv.getAttribute('data-json') || '{}');
                    if (data.benId) {
                        shares.push({
                            benId: data.benId,
                            share: data.share,
                            altId: data.altId
                        });
                    }
                }
            });
            return shares;
        }

        function collectBeneficiaries() {
            const bens = [];

            // 1. Desktop Accordions
            document.querySelectorAll('.beneficiary-item:not(.ben-summary-card)').forEach(row => {
                const uid = row.getAttribute('data-id');
                const nameInput = document.getElementById(`ben-name-${uid}`);

                if (nameInput && nameInput.value) {
                    bens.push({
                        id: uid,
                        name: nameInput.value,
                        rel: document.getElementById(`ben-rel-${uid}`).value,
                        addr: document.getElementById(`ben-addr-${uid}`).value,
                        relPrefix: document.getElementById(`ben-relPrefix-${uid}`).value,
                        father: document.getElementById(`ben-father-${uid}`).value,
                        defaultAltId: document.getElementById(`ben-defaultAlt-${uid}`).value,
                        isMinor: document.getElementById(`ben-minor-${uid}`).checked,
                        gName: document.getElementById(`guardian-name-${uid}`).value,
                        gRel: document.getElementById(`guardian-rel-${uid}`).value,
                        gRelPrefix: document.getElementById(`ben-gRelPrefix-${uid}`).value || 'S/o',
                        gFather: document.getElementById(`guardian-father-${uid}`).value,
                        gAddr: document.getElementById(`guardian-addr-${uid}`).value
                    });
                }
            });

            // 2. Mobile Summary Cards
            document.querySelectorAll('.ben-summary-card').forEach(card => {
                const dataDiv = card.querySelector('.ben-data');
                if (dataDiv) {
                    const json = dataDiv.getAttribute('data-json');
                    if (json) {
                        const data = JSON.parse(json);
                        bens.push(data);
                    }
                }
            });
            return bens;
        }

        // --- BENEFICIARY BOTTOM SHEET LOGIC (Mobile) ---
        let currentBenSheetId = null;

        function openBenSheet(benId = null) {
            currentBenSheetId = benId || generateUniqueId();

            // Push state for back button handling
            history.pushState({ step: lastActiveStep, sheet: 'ben' }, '', '#ben-sheet');

            const sheet = document.getElementById('ben-bottom-sheet');
            const container = document.getElementById('ben-sheet-container');

            renderBenSheet(currentBenSheetId);

            sheet.classList.remove('hidden');
            // Small delay to allow display:block to apply before transform
            setTimeout(() => {
                container.classList.remove('translate-y-full');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function _closeBenSheetUI() {
            const sheet = document.getElementById('ben-bottom-sheet');
            const container = document.getElementById('ben-sheet-container');

            container.classList.add('translate-y-full');
            setTimeout(() => {
                sheet.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300);
        }

        function closeBenSheet() {
            history.back();
        }

        function renderBenSheet(benId) {
            const content = document.getElementById('ben-sheet-content');
            const t = TRANSLATIONS[currentLang];

            // Get existing data if editing
            let data = null;
            if (benId) {
                const benRow = document.getElementById(`ben-row-${benId}`);
                if (benRow) {
                    if (benRow.classList.contains('ben-summary-card')) {
                        // Mobile Summary Card
                        const storedData = benRow.querySelector('.ben-data');
                        if (storedData) {
                            data = JSON.parse(storedData.getAttribute('data-json') || '{}');
                        }
                    } else {
                        // Desktop Accordion (fallback/hybrid)
                        // We can scrape from DOM if needed, but for now let's assume we use summary cards on mobile
                    }
                }
            }

            const html = `
                <div class="space-y-4" id="ben-sheet-form">
                    <!-- Basic Info -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynFullName}</label>
                        <input type="text" id="sheet-ben-name" class="w-full border p-3 rounded-lg text-base outline-none focus:border-indigo-500 transition" placeholder="${t.dynFullName}" value="${data ? data.name : ''}">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynRelationship}</label>
                        <input type="text" id="sheet-ben-rel" class="w-full border p-3 rounded-lg text-base outline-none focus:border-indigo-500 transition" placeholder="${t.dynPhRelationship}" value="${data ? data.rel : ''}">
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynPermAddress}</label>
                        <textarea id="sheet-ben-addr" class="w-full border p-3 rounded-lg text-base outline-none focus:border-indigo-500 transition" rows="3" placeholder="${t.dynPhAddress}">${data ? data.addr : ''}</textarea>
                    </div>

                    <!-- Parent/Spouse -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynParentSpouse}</label>
                        <div class="flex gap-2">
                            <select id="sheet-ben-relPrefix" class="w-1/3 border p-3 rounded-lg text-base bg-white outline-none">
                                <option value="S/o" ${data && data.relPrefix === 'S/o' ? 'selected' : ''}>${t.optSonOf}</option>
                                <option value="D/o" ${data && data.relPrefix === 'D/o' ? 'selected' : ''}>${t.optDaughterOf}</option>
                                <option value="W/o" ${data && data.relPrefix === 'W/o' ? 'selected' : ''}>${t.optWifeOf}</option>
                            </select>
                            <input type="text" id="sheet-ben-father" class="flex-1 border p-3 rounded-lg text-base outline-none" placeholder="${t.dynPhName}" value="${data ? data.father : ''}">
                        </div>
                    </div>

                    <!-- Default Alternate Beneficiary -->
                    <div>
                        <label class="block text-sm font-bold text-gray-400 mb-1">${t.dynDefaultAlternate}</label>
                        <select id="sheet-ben-defaultAlt" class="w-full border p-3 rounded-lg text-base bg-white text-gray-600 outline-none">
                            <option value="">-- ${t.dynDefaultAlternate} --</option>
                        </select>
                    </div>

                    <!-- Minor Checkbox -->
                    <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                        <input type="checkbox" id="sheet-ben-minor" class="w-5 h-5 text-indigo-600 rounded" onchange="document.getElementById('sheet-guardian-section').classList.toggle('hidden', !this.checked)" ${data && data.isMinor ? 'checked' : ''}>
                        <label for="sheet-ben-minor" class="ml-3 text-sm font-bold text-gray-700">${t.dynIsMinor}</label>
                    </div>

                    <!-- Guardian Section -->
                    <div id="sheet-guardian-section" class="${data && data.isMinor ? '' : 'hidden'} space-y-4 border-l-4 border-indigo-100 pl-4">
                        <h3 class="text-sm font-bold text-indigo-600 uppercase tracking-wide">Guardian Details</h3>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">${t.dynGuardianName}</label>
                            <input type="text" id="sheet-guardian-name" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhGuardianName}" value="${data ? data.gName : ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">${t.dynGuardianRel}</label>
                            <input type="text" id="sheet-guardian-rel" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhGuardianRel}" value="${data ? data.gRel : ''}">
                        </div>
                        <!-- Added Missing Guardian Fields -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">${t.dynGuardianParent}</label>
                            <div class="flex gap-2">
                                <select id="sheet-ben-gRelPrefix" class="w-1/3 border p-2 rounded text-sm bg-white outline-none">
                                    <option value="S/o" ${data && data.gRelPrefix === 'S/o' ? 'selected' : ''}>${t.optSonOf}</option>
                                    <option value="D/o" ${data && data.gRelPrefix === 'D/o' ? 'selected' : ''}>${t.optDaughterOf}</option>
                                    <option value="W/o" ${data && data.gRelPrefix === 'W/o' ? 'selected' : ''}>${t.optWifeOf}</option>
                                </select>
                                <input type="text" id="sheet-guardian-father" class="flex-1 border p-2 rounded text-sm outline-none" placeholder="${t.dynPhName}" value="${data ? data.gFather : ''}">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">${t.dynPermAddress}</label>
                            <textarea id="sheet-guardian-addr" class="w-full border p-2 rounded text-sm outline-none" rows="2" placeholder="${t.dynPhAddress}">${data ? data.gAddr : ''}</textarea>
                        </div>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            document.getElementById('ben-sheet-title').textContent = benId && document.getElementById(`ben-row-${benId}`) ? t.dynEdit : t.dynNewBeneficiary;

            // Populate alternate beneficiary dropdown
            const altSelect = document.getElementById('sheet-ben-defaultAlt');
            populateDropdown(altSelect);
            if (data && data.defaultAltId) {
                altSelect.value = data.defaultAltId;
            }
        }

        function saveBenSheet() {
            const benId = currentBenSheetId;

            // Collect Data
            const data = {
                id: benId,
                name: document.getElementById('sheet-ben-name').value,
                rel: document.getElementById('sheet-ben-rel').value,
                addr: document.getElementById('sheet-ben-addr').value,
                relPrefix: document.getElementById('sheet-ben-relPrefix').value,
                father: document.getElementById('sheet-ben-father').value,
                isMinor: document.getElementById('sheet-ben-minor').checked,
                gName: document.getElementById('sheet-guardian-name').value,
                gRel: document.getElementById('sheet-guardian-rel').value,
                gRelPrefix: document.getElementById('sheet-ben-gRelPrefix').value,
                gFather: document.getElementById('sheet-guardian-father').value,
                gAddr: document.getElementById('sheet-guardian-addr').value,
                defaultAltId: document.getElementById('sheet-ben-defaultAlt').value
            };

            if (!data.name) {
                alert(t.errBenName || 'Please enter beneficiary name');
                return;
            }

            // Render Summary Card
            renderBenSummaryCard(benId, data);

            // Update global beneficiaries array if needed (though we usually scrape from DOM)
            // But for mobile summary cards, we store data in DOM attribute

            closeBenSheet();
            saveData();
        }

        // --- RESIDUAL BOTTOM SHEET LOGIC (Mobile) ---
        let currentResidualSheetId = null;

        function openResidualSheet(residualId = null) {
            currentResidualSheetId = residualId || generateUniqueId();

            // Push state for back button handling
            history.pushState({ step: lastActiveStep, sheet: 'residual' }, '', '#residual-sheet');

            const sheet = document.getElementById('residual-bottom-sheet');
            const container = document.getElementById('residual-sheet-container');

            renderResidualSheet(currentResidualSheetId);

            sheet.classList.remove('hidden');
            setTimeout(() => {
                container.classList.remove('translate-y-full');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function _closeResidualSheetUI() {
            const sheet = document.getElementById('residual-bottom-sheet');
            const container = document.getElementById('residual-sheet-container');

            container.classList.add('translate-y-full');
            setTimeout(() => {
                sheet.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300);
        }

        function closeResidualSheet() {
            history.back();
        }

        function renderResidualSheet(residualId) {
            const content = document.getElementById('residual-sheet-content');
            const t = TRANSLATIONS[currentLang];

            // Get existing data if editing
            let data = null;
            if (residualId) {
                const residualCard = document.getElementById(`residual-card-${residualId}`);
                if (residualCard && residualCard.classList.contains('residual-summary-card')) {
                    const storedData = residualCard.querySelector('.residual-data');
                    if (storedData) {
                        data = JSON.parse(storedData.getAttribute('data-json') || '{}');
                    }
                }
            }

            // Auto-calculate share if new entry
            let defaultShare = '100';
            if (data) {
                defaultShare = data.share;
            } else {
                const existingShares = collectResidualShares();
                let totalShare = 0;
                existingShares.forEach(s => totalShare += parseFloat(s.share) || 0);
                const remaining = Math.max(0, 100 - totalShare);
                defaultShare = remaining > 0 ? remaining : '';
            }

            const html = `
                <div class="space-y-4" id="residual-sheet-form">
                    <!-- Beneficiary -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynBeneficiaries}</label>
                        <select id="sheet-residual-ben" class="w-full border p-3 rounded-lg text-base bg-white outline-none focus:border-indigo-500 transition" onchange="onSheetResidualBenChange(this)">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    
                    <!-- Share Percentage -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">${t.dynPercentShare}</label>
                        <div class="relative">
                            <input type="number" id="sheet-residual-share" class="w-full border p-3 rounded-lg text-base font-bold text-center bg-white outline-none focus:border-indigo-500 transition" value="${defaultShare}" min="1" max="100">
                            <span class="absolute right-4 top-4 text-sm text-gray-400 font-bold">%</span>
                        </div>
                    </div>

                    <!-- Alternate Beneficiary -->
                    <div>
                        <label class="block text-sm font-bold text-gray-400 mb-1">${t.dynAlternate}</label>
                        <select id="sheet-residual-alt" class="w-full border p-3 rounded-lg text-base bg-white text-gray-600 outline-none">
                            <option value="">--</option>
                        </select>
                    </div>
                </div>
            `;

            content.innerHTML = html;

            // Populate dropdowns
            const benSelect = document.getElementById('sheet-residual-ben');
            const altSelect = document.getElementById('sheet-residual-alt');
            populateDropdown(benSelect);
            populateDropdown(altSelect);

            if (data) {
                benSelect.value = data.benId || '';
                altSelect.value = data.altId || '';
            }
        }

        function onSheetResidualBenChange(selectEl) {
            const benId = selectEl.value;
            if (!benId) return;
            const ben = beneficiaries.find(b => b.id == benId);
            const altSelect = document.getElementById('sheet-residual-alt');
            if (ben && ben.defaultAltId) altSelect.value = ben.defaultAltId;
        }

        function saveResidualSheet() {
            const residualId = currentResidualSheetId;

            const data = {
                id: residualId,
                benId: document.getElementById('sheet-residual-ben').value,
                share: document.getElementById('sheet-residual-share').value,
                altId: document.getElementById('sheet-residual-alt').value
            };

            if (!data.benId) {
                alert(t.errSelectBen || 'Please select a beneficiary');
                return;
            }

            // Render Summary Card
            renderResidualSummaryCard(residualId, data);

            closeResidualSheet();
            saveData();
        }

        function renderResidualSummaryCard(residualId, data) {
            const container = document.getElementById('residual-shares-list');
            const t = TRANSLATIONS[currentLang];

            // Remove existing if updating
            const existing = document.getElementById(`residual-card-${residualId}`);
            if (existing) existing.remove();

            // Get beneficiary name
            const ben = beneficiaries.find(b => b.id == data.benId);
            const benName = ben ? ben.name : 'Unknown';

            const html = `
                <div id="residual-card-${residualId}" class="residual-summary-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-3 cursor-pointer hover:bg-gray-50 transition" onclick="openResidualSheet('${residualId}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-sm truncate">${benName}</h3>
                            <p class="text-xs text-gray-500">${data.share}${t.dynPercentShare}</p>
                        </div>
                        <button onclick="event.stopPropagation(); removeResidualCard('${residualId}')" class="text-gray-400 hover:text-red-500 p-2 transition ml-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <!-- Hidden Data Storage -->
                    <div class="hidden residual-data" data-json='${JSON.stringify(data)}'></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);
        }

        function removeResidualCard(residualId) {
            const card = document.getElementById(`residual-card-${residualId}`);
            if (card) {
                card.remove();
                saveData();
            }
        }

        function renderBenSummaryCard(benId, data) {
            console.log(`[RenderBenSummaryCard] benId param: ${benId}, data.id: ${data.id}, type: ${typeof benId}`);
            const container = document.getElementById('beneficiary-container');

            // Remove existing if updating
            const existing = document.getElementById(`ben-row-${benId}`);
            if (existing) existing.remove();

            const html = `
                <div id="ben-row-${benId}" class="ben-summary-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-3 cursor-pointer hover:bg-gray-50 transition" onclick="openBenSheet('${benId}')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-xl flex-shrink-0">
                            ${data.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-sm truncate">${data.name}</h3>
                            <p class="text-xs text-gray-500 truncate">${data.rel}</p>
                        </div>
                        <button onclick="event.stopPropagation(); removeBeneficiaryRow('${benId}')" class="text-gray-400 hover:text-red-500 p-2 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <!-- Hidden Data Storage -->
                    <!-- Hidden Data Storage -->
                    <div class="hidden ben-data" data-json='${JSON.stringify({ ...data, id: String(data.id) })}'></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);
        }

        // --- ASSET BOTTOM SHEET LOGIC (Mobile) ---
        let currentAssetSheetId = null;
        let isLoadingData = false; // Prevent bottom sheet from opening during data load

        function isMobile() {
            return window.innerWidth < 768;
        }

        function openAssetSheet(assetId = null) {
            if (!isMobile() || isLoadingData) return; // Only for mobile and not during data load

            currentAssetSheetId = assetId;

            // Push state for back button handling
            history.pushState({ step: lastActiveStep, sheet: 'asset' }, '', '#asset-sheet');

            const t = TRANSLATIONS[currentLang];
            const sheet = document.getElementById('asset-bottom-sheet');
            const container = document.getElementById('asset-sheet-container');
            const title = document.getElementById('asset-sheet-title');

            // Set title
            title.textContent = assetId ? t.dynEdit + ' ' + t.dynAssetType : t.dynNewAsset;

            // Render content
            renderAssetSheet(assetId);

            // Show with animation
            sheet.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Slide up animation
            setTimeout(() => {
                container.style.transform = 'translateY(0)';
            }, 10);
        }

        function _closeAssetSheetUI() {
            const sheet = document.getElementById('asset-bottom-sheet');
            const container = document.getElementById('asset-sheet-container');

            // Slide down animation
            container.style.transform = 'translateY(100%)';

            setTimeout(() => {
                sheet.classList.add('hidden');
                document.body.style.overflow = 'auto';
                currentAssetSheetId = null;
            }, 300);
        }

        function closeAssetSheet() {
            history.back();
        }

        function renderAssetSheet(assetId) {
            const content = document.getElementById('asset-sheet-content');
            const t = TRANSLATIONS[currentLang];

            // Get existing asset data if editing
            let assetData = null;
            let existingBeneficiaries = [];

            if (assetId) {
                const assetRow = document.getElementById(`asset-row-${assetId}`);
                if (assetRow) {
                    // Check if it's a mobile summary card or desktop accordion
                    if (assetRow.classList.contains('asset-summary-card')) {
                        // Mobile summary card
                        const type = assetRow.getAttribute('data-type');
                        const benData = assetRow.querySelector('.asset-data');
                        if (benData) {
                            existingBeneficiaries = JSON.parse(benData.getAttribute('data-beneficiaries') || '[]');
                        }

                        const fieldsData = assetRow.querySelector('.asset-fields-data');
                        let fields = {};
                        if (fieldsData) {
                            fields = JSON.parse(fieldsData.getAttribute('data-fields') || '{}');
                        }

                        assetData = { type, fields };
                    } else {
                        // Desktop accordion
                        const typeSelect = assetRow.querySelector('.asset-type-select');
                        assetData = {
                            type: typeSelect ? typeSelect.value : '',
                            fields: {}
                        };
                        // Collect field values
                        assetRow.querySelectorAll('.dynamic-field-input').forEach(inp => {
                            assetData.fields[inp.getAttribute('data-key')] = inp.value;
                        });
                        // Reload Executors
                        const currentExecutors = collectExecutors();
                        document.getElementById('primary-executors-container').innerHTML = '';
                        document.getElementById('alternate-executor-container').innerHTML = '';

                        currentExecutors.forEach(ex => {
                            renderExecutorRow(ex);
                        });

                        // Show/hide alternate button
                        const hasAlternate = currentExecutors.some(e => !e.isPrimary);
                        const altBtn = document.getElementById('btn-add-alternate');
                        if (altBtn) {
                            if (hasAlternate) altBtn.classList.add('hidden');
                            else altBtn.classList.remove('hidden');
                        }

                        // Reload Beneficiaries
                        assetRow.querySelectorAll('.share-row').forEach(row => {
                            const benId = row.querySelector('.ben-select-share')?.value;
                            const share = row.querySelector('.share-input')?.value;
                            const altId = row.querySelector('.ben-select-alt-share')?.value;
                            if (benId) {
                                existingBeneficiaries.push({ benId, share, altId });
                            }
                        });
                    }
                }
            }

            // Build HTML
            let html = `
                <div class="space-y-4">
                    <!-- Asset Type -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">${t.dynAssetType}</label>
                        <select id="sheet-asset-type" class="w-full border p-3 rounded text-sm bg-white outline-none" onchange="updateSheetFields()">
                            <option value="">${t.dynSelectAssetType}</option>
                            <optgroup label="${t.assetOptRealEstate}"><option value="flat">${t.assetOptFlat}</option><option value="land">${t.assetOptLand}</option><option value="shop">${t.assetOptShop}</option></optgroup>
                            <optgroup label="${t.assetOptBankCash}"><option value="savings">${t.assetOptSavings}</option><option value="fd">${t.assetOptFD}</option><option value="locker">${t.assetOptLocker}</option><option value="loan">${t.assetOptLoan}</option></optgroup>
                            <optgroup label="${t.assetOptInvestments}"><option value="nps">${t.assetOptNPS}</option><option value="mf">${t.assetOptMF}</option><option value="demat">${t.assetOptDemat}</option><option value="crypto">${t.assetOptCrypto}</option><option value="insurance">${t.assetOptInsurance}</option></optgroup>
                            <optgroup label="${t.assetOptBusiness}"><option value="esop">${t.assetOptESOP}</option><option value="business">${t.assetOptBusinessInt}</option></optgroup>
                            <optgroup label="${t.assetOptValuables}"><option value="jewelry">${t.assetOptJewelry}</option><option value="vehicle">${t.assetOptVehicle}</option></optgroup>
                        </select>
                    </div>
                    
                    <!-- Dynamic Fields -->
                    <div id="sheet-dynamic-fields"></div>
                    
                    <!-- Beneficiaries Section -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">${t.dynBeneficiaries}</h3>
                        <div id="sheet-beneficiaries" class="space-y-2">
                            <!-- Beneficiaries will be added here -->
                        </div>
                        <button onclick="addSheetBeneficiary()" class="mt-3 text-xs flex items-center gap-1 bg-white border border-indigo-200 text-indigo-600 font-bold px-3 py-2 rounded hover:bg-indigo-50 transition w-full justify-center">
                            ${t.dynAddShare}
                        </button>
                    </div>
                </div>
            `;

            content.innerHTML = html;

            // Set values if editing
            if (assetData) {
                document.getElementById('sheet-asset-type').value = assetData.type;
                updateSheetFields();

                // Populate field values
                setTimeout(() => {
                    Object.keys(assetData.fields).forEach(key => {
                        const input = document.querySelector(`#sheet-dynamic-fields [data-key="${key}"]`);
                        if (input) input.value = assetData.fields[key];
                    });

                    // Populate beneficiaries
                    existingBeneficiaries.forEach(ben => {
                        addSheetBeneficiary(ben.benId, ben.share, ben.altId);
                    });
                }, 50);
            }
        }

        function updateSheetFields() {
            const type = document.getElementById('sheet-asset-type').value;
            const container = document.getElementById('sheet-dynamic-fields');
            const t = TRANSLATIONS[currentLang];

            if (!type) {
                container.innerHTML = '';
                return;
            }

            const schema = ASSET_SCHEMAS[type] || ASSET_SCHEMAS['jewelry'];
            let html = '';

            schema.forEach(field => {
                const labelText = currentLang === 'hi' ? (field.labelHi || field.label) : field.label;
                html += `
                    <div class="mb-3">
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">${labelText}</label>
                        ${field.type === 'textarea'
                        ? `<textarea data-key="${field.key}" class="w-full border p-3 rounded text-sm outline-none" rows="2" placeholder="${labelText}"></textarea>`
                        : `<input type="text" data-key="${field.key}" class="w-full border p-3 rounded text-sm outline-none" placeholder="${labelText}">`
                    }
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function addSheetBeneficiary(benIdValue = '', shareValue = '', altIdValue = '') {
            const container = document.getElementById('sheet-beneficiaries');
            const t = TRANSLATIONS[currentLang];
            const rowId = generateUniqueId();

            // Auto-calculate share if not provided
            if (!shareValue) {
                let totalShare = 0;
                container.querySelectorAll('.sheet-share-input').forEach(input => {
                    totalShare += parseFloat(input.value) || 0;
                });
                const remaining = Math.max(0, 100 - totalShare);
                shareValue = remaining > 0 ? remaining : '';
            }

            const html = `
                <div class="sheet-ben-row bg-gray-50 p-3 rounded border border-gray-200" data-id="${rowId}">
                    <div class="grid grid-cols-12 gap-2 items-start">
                        <div class="col-span-5">
                            <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1 truncate">${t.dynBeneficiaries}</label>
                            <select class="sheet-ben-select w-full border p-2 rounded text-sm bg-white outline-none" onchange="onSheetBenChange(this)">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="col-span-3">
                            <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1 truncate">${t.dynPercentShare}</label>
                            <div class="relative">
                                <input type="number" class="sheet-share-input w-full border p-2 rounded text-sm text-center bg-white outline-none" value="${shareValue}" min="1" max="100">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-gray-400 font-bold">%</span>
                            </div>
                        </div>
                        <div class="col-span-3">
                            <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1 truncate">${t.dynAlternate}</label>
                            <select class="sheet-alt-select w-full border p-2 rounded text-sm bg-white text-gray-600 outline-none">
                                <option value="">--</option>
                            </select>
                        </div>
                        <div class="col-span-1 flex justify-center mt-5">
                            <button onclick="this.closest('.sheet-ben-row').remove()" class="text-gray-300 hover:text-red-500 transition p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);

            // Populate dropdowns
            const newRow = container.querySelector(`[data-id="${rowId}"]`);
            const benSelect = newRow.querySelector('.sheet-ben-select');
            const altSelect = newRow.querySelector('.sheet-alt-select');

            // CRITICAL FIX: Fetch fresh beneficiaries directly from DOM instead of relying on global variable
            // The global variable seems to be corrupted with simple IDs (1, 3, 5, 7) in some cases
            const freshBeneficiaries = collectBeneficiaries();

            freshBeneficiaries.forEach(b => {
                const o = document.createElement('option');
                o.value = String(b.id);
                o.textContent = b.name;
                benSelect.appendChild(o);

                const oa = document.createElement('option');
                oa.value = String(b.id);
                oa.textContent = b.name;
                altSelect.appendChild(oa);
            });

            // Set values if provided - ensure type conversion
            if (benIdValue) {
                const strId = String(benIdValue);
                benSelect.value = strId;
            }

            if (altIdValue) {
                const strAltId = String(altIdValue);
                altSelect.value = strAltId;
            }
        }

        function saveAssetSheet() {
            const type = document.getElementById('sheet-asset-type').value;
            if (!type) {
                alert(t.errSelectAssetType || 'Please select an asset type');
                return;
            }

            const assetId = currentAssetSheetId;
            const t = TRANSLATIONS[currentLang];

            // Collect field data
            const fieldData = {};
            document.querySelectorAll('#sheet-dynamic-fields [data-key]').forEach(input => {
                fieldData[input.getAttribute('data-key')] = input.value;
            });

            // Collect beneficiary data
            const beneficiaries = [];
            document.querySelectorAll('.sheet-ben-row').forEach(row => {
                const benId = row.querySelector('.sheet-ben-select').value;
                const share = row.querySelector('.sheet-share-input').value;
                const altId = row.querySelector('.sheet-alt-select').value;
                if (benId) {
                    beneficiaries.push({ benId, share, altId });
                }
            });

            // Check if asset row exists
            let assetRow = document.getElementById(`asset-row-${assetId}`);

            if (!assetRow) {
                // Create new asset row
                const container = document.getElementById('asset-container');

                if (isMobile()) {
                    // Mobile: Create minimal summary card
                    renderMobileSummaryCard(assetId, type, beneficiaries, fieldData);
                } else {
                    // Desktop: Create full accordion (reuse existing logic)
                    createDesktopAssetRow(assetId, type, fieldData, beneficiaries);
                }
            } else {
                // Update existing asset row
                const assetRow = document.getElementById(`asset-row-${assetId}`);

                if (assetRow.classList.contains('asset-summary-card')) {
                    // Update mobile card - preserve position
                    const container = assetRow.parentElement;
                    const nextSibling = assetRow.nextSibling;
                    assetRow.remove();

                    // Temporarily render to get the HTML
                    renderMobileSummaryCard(assetId, type, beneficiaries, fieldData);

                    // Insert at the same position
                    const newCard = document.getElementById(`asset-row-${assetId}`);
                    if (newCard && nextSibling) {
                        container.insertBefore(newCard, nextSibling);
                    } else if (newCard && !nextSibling) {
                        // Was the last card, append it back
                        container.appendChild(newCard);
                    }
                } else {
                    // Update desktop accordion
                    const typeSelect = assetRow.querySelector('.asset-type-select');
                    if (typeSelect) {
                        typeSelect.value = type;
                        renderAssetFields(assetId, type);

                        // Update field values
                        Object.keys(fieldData).forEach(key => {
                            const input = assetRow.querySelector(`[data-key="${key}"]`);
                            if (input) input.value = fieldData[key];
                        });

                        // Update beneficiaries
                        const sharesContainer = document.getElementById(`shares-container-${assetId}`);
                        if (sharesContainer) {
                            sharesContainer.innerHTML = '';
                            beneficiaries.forEach(b => {
                                addShareRow(assetId, b.benId, b.share, b.altId);
                            });
                        }

                        updateAssetHeader(assetId);
                    }
                }
            }

            closeAssetSheet();
            saveData();
        }

        function renderMobileSummaryCard(assetId, type, beneficiaries, fieldData = {}) {
            const container = document.getElementById('asset-container');
            const t = TRANSLATIONS[currentLang];
            const icon = ASSET_ICONS[type] || 'üìÑ';

            // Map asset type values to translation keys
            const assetTypeMap = {
                'flat': t.assetOptFlat,
                'land': t.assetOptLand,
                'shop': t.assetOptShop,
                'savings': t.assetOptSavings,
                'fd': t.assetOptFD,
                'locker': t.assetOptLocker,
                'loan': t.assetOptLoan,
                'nps': t.assetOptNPS,
                'mf': t.assetOptMF,
                'demat': t.assetOptDemat,
                'crypto': t.assetOptCrypto,
                'insurance': t.assetOptInsurance,
                'esop': t.assetOptESOP,
                'business': t.assetOptBusinessInt,
                'jewelry': t.assetOptJewelry,
                'vehicle': t.assetOptVehicle
            };

            const typeLabel = assetTypeMap[type] || type;
            const benCount = beneficiaries.length;

            const html = `
                <div id="asset-row-${assetId}" class="asset-summary-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-3 cursor-pointer hover:bg-gray-50 transition" onclick="openAssetSheet(${assetId})" data-type="${type}">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-2xl flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-sm truncate">${typeLabel}</h3>
                            <p class="text-xs text-gray-500">‚Üí ${benCount} ${t.dynBeneficiaries}</p>
                        </div>
                        <button onclick="event.stopPropagation(); removeMobileAsset(${assetId})" class="text-gray-400 hover:text-red-500 p-2 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <!-- Hidden data storage -->
                    <div class="hidden asset-data" data-beneficiaries='${JSON.stringify(beneficiaries)}'></div>
                    <div class="hidden asset-fields-data" data-fields='${JSON.stringify(fieldData)}'></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', html);
        }

        function removeMobileAsset(assetId) {
            if (confirm(TRANSLATIONS[currentLang].confirmDeleteAsset)) {
                document.getElementById(`asset-row-${assetId}`)?.remove();
                saveData();
            }
        }

        function createDesktopAssetRow(assetId, type, fieldData, beneficiaries) {
            // This would be the full accordion creation logic
            // For now, we'll skip this as desktop keeps the existing accordion
        }

        function getValOrPlace(id, placeholder) {
            const val = document.getElementById(id) ? document.getElementById(id).value : '';
            return val.trim() ? val : `<span class="preview-placeholder">[${placeholder}]</span>`;
        }

        function renderPreview() {
            const container = document.getElementById('preview-content');
            const t = TRANSLATIONS[currentLang];
            const today = new Date().toLocaleDateString(currentLang === 'hi' ? 'hi-IN' : 'en-IN', { year: 'numeric', month: 'long', day: 'numeric' });

            // Helper for beneficiaries
            // Helper function to translate relationship prefixes to Hindi
            const translateRelPrefix = (prefix) => {
                if (currentLang !== 'hi') return prefix;
                const translations = {
                    'S/o': '‡§™‡•Å‡§§‡•ç‡§∞',
                    'D/o': '‡§™‡•Å‡§§‡•ç‡§∞‡•Ä',
                    'W/o': '‡§™‡§§‡•ç‡§®‡•Ä',
                    'R/o': '‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä'
                };
                return translations[prefix] || prefix;
            };

            const getBenString = (bId) => {
                const b = beneficiaries.find(x => x.id == bId);
                if (!b) return `<span class="preview-placeholder">[Beneficiary]</span>`;
                let s = `<b>${b.name}</b> (${b.rel})`;
                if (b.addr) s += `, ${translateRelPrefix('R/o')} ${b.addr}`;
                if (b.father && b.father.trim()) s += `, ${translateRelPrefix(b.relPrefix || 'S/o')} ${b.father}`;
                if (b.isMinor && b.gName) {
                    s += ` [Minor. Guardian: ${b.gName}`;
                    if (b.gRel) s += ` (${b.gRel})`;
                    if (b.gFather && b.gFather.trim()) s += `, ${translateRelPrefix(b.gRelPrefix || 'S/o')} ${b.gFather}`;
                    if (b.gAddr) s += `, ${translateRelPrefix('R/o')} ${b.gAddr}`;
                    s += `]`;
                }
                return s;
            };

            // 1. Title
            let html = `<h1 style="text-align: center; font-size: 22pt; font-weight: bold; margin-bottom: 10px;">${t.pdfTitle}</h1>`;
            html += `<hr style="border: 0; border-top: 1px solid #000; margin-bottom: 30px;">`;

            // 2. Preamble
            let religionTxt = getValOrPlace('religionSelector', t.pdfReligionLabel);
            if (document.getElementById('religionSelector').value === 'Other') religionTxt = getValOrPlace('customReligion', t.pdfReligionLabel);

            // Translate religion if possible
            if (currentLang === 'hi') {
                if (religionTxt === 'Hindu') religionTxt = '‡§π‡§ø‡§Ç‡§¶‡•Ç';
                else if (religionTxt === 'Muslim') religionTxt = '‡§Æ‡•Å‡§∏‡•ç‡§≤‡§ø‡§Æ';
                else if (religionTxt === 'Christian') religionTxt = '‡§à‡§∏‡§æ‡§à';
                else if (religionTxt === 'Sikh') religionTxt = '‡§∏‡§ø‡§ñ';
                else if (religionTxt === 'Jain') religionTxt = '‡§ú‡•à‡§®';
                else if (religionTxt === 'Buddhist') religionTxt = '‡§¨‡•å‡§¶‡•ç‡§ß';
            }

            const myName = getValOrPlace('myName', t.dynFullName).toUpperCase();
            const fatherName = document.getElementById('fatherName') ? document.getElementById('fatherName').value.trim() : '';
            const myRelPrefix = document.getElementById('myRelPrefix') ? document.getElementById('myRelPrefix').value : 'S/o';
            // Translate relationship prefix
            let myRelPrefixTrans = myRelPrefix;
            if (currentLang === 'hi') {
                if (myRelPrefix === 'S/o') myRelPrefixTrans = '‡§™‡•Å‡§§‡•ç‡§∞';
                else if (myRelPrefix === 'D/o') myRelPrefixTrans = '‡§™‡•Å‡§§‡•ç‡§∞‡•Ä';
                else if (myRelPrefix === 'W/o') myRelPrefixTrans = '‡§™‡§§‡•ç‡§®‡•Ä';
            }

            // Determine gender for Hindi grammar
            const isFemale = (myRelPrefix === 'D/o' || myRelPrefix === 'W/o');
            const fixHindiGender = (text) => {
                if (currentLang !== 'hi') return text;
                if (isFemale) {
                    return text.replace(/‡§ï‡§∞‡§§‡§æ\/‡§ï‡§∞‡§§‡•Ä/g, '‡§ï‡§∞‡§§‡•Ä')
                        .replace(/‡§¨‡§®‡§æ‡§§‡§æ\/‡§¨‡§®‡§æ‡§§‡•Ä/g, '‡§¨‡§®‡§æ‡§§‡•Ä')
                        .replace(/‡§∞‡§π‡§æ\/‡§∞‡§π‡•Ä/g, '‡§∞‡§π‡•Ä')
                        .replace(/‡§π‡•Ç‡§Ç/g, '‡§π‡•Ç‡§Ç'); // Keep as is for female
                } else {
                    return text.replace(/‡§ï‡§∞‡§§‡§æ\/‡§ï‡§∞‡§§‡•Ä/g, '‡§ï‡§∞‡§§‡§æ')
                        .replace(/‡§¨‡§®‡§æ‡§§‡§æ\/‡§¨‡§®‡§æ‡§§‡•Ä/g, '‡§¨‡§®‡§æ‡§§‡§æ')
                        .replace(/‡§∞‡§π‡§æ\/‡§∞‡§π‡•Ä/g, '‡§∞‡§π‡§æ'); // FIX: was '‡§∞‡§π‡•Ä', should be '‡§∞‡§π‡§æ' for male
                }
            };

            let preamble = "";
            const myDobVal = document.getElementById('myDob') ? document.getElementById('myDob').value : '';
            let dobText = "";
            if (myDobVal) {
                const dobDate = new Date(myDobVal);
                const dobStr = dobDate.toLocaleDateString(currentLang === 'hi' ? 'hi-IN' : 'en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
                dobText = currentLang === 'en' ? `, born on ${dobStr}` : `, ‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø ${dobStr}`;
            }

            if (currentLang === 'en') {
                preamble = `I, <b>${myName}</b>`;
                if (fatherName) preamble += `, ${myRelPrefix} ${fatherName}`;
                if (dobText) preamble += dobText;
                preamble += `, residing at ${getValOrPlace('myAddress', 'Permanent Address')} (Religion: ${religionTxt}), being of sound mind and memory, do hereby make, publish and declare this to be my Last Will and Testament.`;
            } else {
                preamble = `‡§Æ‡•à‡§Ç, <b>${myName}</b>`;
                if (fatherName) preamble += `, ${translateRelPrefix(myRelPrefix)} ${fatherName}`;
                if (dobText) preamble += dobText;
                let preambleText = `, ‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä ${getValOrPlace('myAddress', t.dynPermAddress)} (‡§ß‡§∞‡•ç‡§Æ: ${religionTxt}), ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§Æ‡§® ‡§î‡§∞ ‡§∏‡•ç‡§Æ‡•É‡§§‡§ø ‡§ï‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§®‡§æ‡§§‡•á, ‡§è‡§§‡§¶‡•ç‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§Ø‡§π ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§µ‡§∏‡•Ä‡§Ø‡§§ ‡§î‡§∞ ‡§µ‡§∏‡•Ä‡§Ø‡§§‡§®‡§æ‡§Æ‡§æ ‡§¨‡§®‡§æ‡§§‡§æ/‡§¨‡§®‡§æ‡§§‡•Ä ‡§π‡•Ç‡§Å, ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ/‡§ï‡§∞‡§§‡•Ä ‡§π‡•Ç‡§Å ‡§î‡§∞ ‡§ò‡•ã‡§∑‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ/‡§ï‡§∞‡§§‡•Ä ‡§π‡•Ç‡§Å‡•§`;
                preamble += fixHindiGender(preambleText);
            }
            html += `<p style="margin-bottom: 15px;">${preamble}</p>`;

            // 3. Revocation
            html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.pdfRevocationTitle}</h3>`;
            html += `<p style="margin-bottom: 15px;">${fixHindiGender(t.pdfRevocationText)}</p>`;

            // 4. Executor
            html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.pdfExecutorTitle}</h3>`;

            // Ensure we have the latest executor data
            const currentExecutors = collectExecutors();
            const primaryExecutors = currentExecutors.filter(e => e.isPrimary);
            const alternateExecutor = currentExecutors.find(e => !e.isPrimary);

            // Helper to translate "S/o Name" -> "‡§™‡•Å‡§§‡•ç‡§∞ Name"
            const translateParentName = (fullString) => {
                if (!fullString || currentLang !== 'hi') return fullString;
                const parts = fullString.split(' ');
                if (parts.length > 1) {
                    const prefix = parts[0];
                    const translatedPrefix = translateRelPrefix(prefix);
                    if (translatedPrefix !== prefix) {
                        return translatedPrefix + ' ' + parts.slice(1).join(' ');
                    }
                }
                return fullString;
            };

            if (primaryExecutors.length > 0) {
                // Only show "Primary Executor(s)" heading when alternate exists (to distinguish from alternate)
                if (alternateExecutor) {
                    html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.previewPrimaryExecutors}</h3>`;
                }

                if (primaryExecutors.length === 1) {
                    const ex = primaryExecutors[0];
                    let exText = `I appoint <b>${ex.name}</b> (${t.lblExRel}: ${ex.relationship})`;
                    if (ex.parentName) exText += `, ${translateParentName(ex.parentName)}`;
                    if (ex.address) exText += `, ${t.lblExAddress}: ${ex.address}`;
                    exText += `, to be the sole Executor of this Will.`;
                    html += `<p style="margin-bottom: 10px;">${exText}</p>`;
                } else {
                    // Multiple executors
                    html += `<p style="margin-bottom: 10px;"><b>${fixHindiGender(t.previewExecutorClause)}</b></p>`;
                    primaryExecutors.forEach((ex, index) => {
                        let exText = `(${String.fromCharCode(97 + index)}) <b>${ex.name}</b> (${t.lblExRel}: ${ex.relationship})`;
                        if (ex.parentName) exText += `, ${translateParentName(ex.parentName)}`;
                        if (ex.address) exText += `, ${t.lblExAddress}: ${ex.address}`;
                        html += `<p style="margin-bottom: 5px; margin-left: 20px;">${exText}</p>`;
                    });
                    html += `<p style="margin-top: 10px; font-style: italic;">${t.previewJointSeveral}</p>`;
                }
            }

            if (alternateExecutor) {
                html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.previewAlternateExecutor}</h3>`;
                html += `<p style="margin-bottom: 10px;"><b>${fixHindiGender(t.previewAlternateClause)}</b></p>`;

                let altText = `<b>${alternateExecutor.name}</b> (${t.lblExRel}: ${alternateExecutor.relationship})`;
                if (alternateExecutor.parentName) altText += `, ${translateParentName(alternateExecutor.parentName)}`;
                if (alternateExecutor.address) altText += `, ${t.lblExAddress}: ${alternateExecutor.address}`;
                html += `<p style="margin-bottom: 15px;">${altText}</p>`;
            }

            // 5. Assets
            html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.pdfDistributionTitle}</h3>`;
            html += `<p style="margin-bottom: 15px;">${fixHindiGender(t.pdfDistributionIntro)}</p>`;

            const allAssets = collectAllAssets();
            if (allAssets.length === 0) {
                html += `<p class="preview-placeholder" style="margin-left: 20px;">[No assets added yet...]</p>`;
            } else {
                allAssets.forEach((asset, idx) => {
                    // Get type label
                    const typeKey = `assetOpt${asset.type.charAt(0).toUpperCase() + asset.type.slice(1)}`;
                    const typeLabel = t[typeKey] || asset.type;

                    // Description
                    let desc = "";
                    Object.entries(asset.details).forEach(([key, value]) => {
                        if (value) {
                            const schema = ASSET_SCHEMAS[asset.type];
                            const field = schema?.find(f => f.key === key);
                            const label = currentLang === 'hi' ? (field?.labelHi || field?.label) : field?.label;
                            desc += `${label || key}: ${value}, `;
                        }
                    });
                    if (desc.length > 2) desc = desc.substring(0, desc.length - 2);
                    if (!desc) desc = `<span class="preview-placeholder">[Asset Description]</span>`;

                    html += `<div style="margin-bottom: 20px; margin-left: 10px;">`;
                    html += `<div style="font-weight: bold; font-size: 13pt; margin-bottom: 5px;">${idx + 1}. ${typeLabel.toUpperCase()}</div>`;
                    html += `<div style="font-weight: bold; margin-bottom: 5px;">${t.pdfDescriptionLabel}: <span style="font-weight: normal;">${desc}</span></div>`;
                    html += `<div style="font-style: italic; margin-bottom: 5px;">${t.pdfBeneficiariesLabel}:</div>`;

                    // Shares
                    if (asset.shares.length === 0) {
                        html += `<div style="margin-left: 20px;" class="preview-placeholder">[No beneficiaries assigned]</div>`;
                    } else {
                        html += `<ul style="list-style-type: none; padding-left: 20px; margin: 0;">`;
                        asset.shares.forEach((share, sIdx) => {
                            const bullet = String.fromCharCode(97 + sIdx);
                            const toStr = currentLang === 'hi' ? '‡§ï‡•ã' : 'to';

                            html += `<li style="margin-bottom: 5px;">(${bullet}) ${share.share}% ${toStr} ${getBenString(share.benId)}`;
                            if (share.altId) {
                                html += `<div style="font-size: 10pt; color: #555; margin-left: 20px;">${t.pdfAlternateLabel}: ${getBenString(share.altId)}</div>`;
                            }
                            html += `</li>`;
                        });
                        html += `</ul>`;
                    }
                    html += `</div>`;
                });
            }

            // 6. Residual
            html += `<h3 style="font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">${t.pdfResidualTitle}</h3>`;
            html += `<p style="margin-bottom: 10px;">${fixHindiGender(t.pdfResidualIntro)}</p>`;

            const resShares = collectResidualShares();
            if (resShares.length === 0) {
                html += `<p class="preview-placeholder" style="margin-left: 20px;">[No residual beneficiaries selected...]</p>`;
            } else {
                html += `<ul style="list-style-type: none; padding-left: 20px; margin: 0;">`;
                resShares.forEach((share, idx) => {
                    const bullet = String.fromCharCode(97 + idx);
                    const toStr = currentLang === 'hi' ? '‡§ï‡•ã' : 'to';

                    html += `<li style="margin-bottom: 5px;">(${bullet}) ${share.share}% ${toStr} ${getBenString(share.benId)}`;
                    if (share.altId) {
                        html += `<div style="font-size: 10pt; color: #555; margin-left: 20px;">${t.pdfAlternateLabel}: ${getBenString(share.altId)}</div>`;
                    }
                    html += `</li>`;
                });
                html += `</ul>`;
            }

            // 7. Signatures
            html += `<div style="margin-top: 50px;">`;
            html += `<h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 10px;">${currentLang === 'hi' ? '‡§á‡§∏‡§ï‡•á ‡§∏‡§æ‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç' : 'IN WITNESS WHEREOF'}</h3>`;
            const witnessText = currentLang === 'hi'
                ? `‡§Æ‡•à‡§Ç‡§®‡•á ${getValOrPlace('myPlace', '‡§∏‡•ç‡§•‡§æ‡§®')} ‡§Æ‡•á‡§Ç ${today} ‡§ï‡•ã ‡§á‡§∏ ‡§µ‡§∏‡•Ä‡§Ø‡§§ ‡§™‡§∞ ‡§Ö‡§™‡§®‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§`
                : `I have set my hand to this Will at ${getValOrPlace('myPlace', 'Place')} on ${today}.`;
            html += `<p style="margin-bottom: 30px;">${witnessText}</p>`;

            // Testator Sign
            html += `<div style="margin-bottom: 40px;">`;
            html += `<div style="border-top: 1px solid #000; width: 200px; margin-bottom: 5px;"></div>`;
            html += `<div style="font-weight: bold;">${currentLang === 'hi' ? '‡§µ‡§∏‡•Ä‡§Ø‡§§‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞' : 'TESTATOR SIGNATURE'}</div>`;
            html += `<div>(${getValOrPlace('myName', t.dynFullName)})</div>`;
            html += `</div>`;

            // Witnesses
            html += `<h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 10px;">${currentLang === 'hi' ? '‡§ó‡§µ‡§æ‡§π‡•ã‡§Ç ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§ø‡§§' : 'SIGNED BY THE WITNESSES'}</h3>`;
            const witnessCert = currentLang === 'hi'
                ? '‡§π‡§Æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§µ‡§∏‡•Ä‡§Ø‡§§‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§µ‡§∏‡•Ä‡§Ø‡§§ ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è, ‡§î‡§∞ ‡§π‡§Æ‡§®‡•á ‡§â‡§®‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§ó‡§µ‡§æ‡§π‡•ã‡§Ç ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è‡•§'
                : 'We certify that the Testator signed this Will in our presence, and we have signed as witnesses in their presence.';
            html += `<p style="margin-bottom: 30px;">${witnessCert}</p>`;

            html += `<div style="display: flex; justify-content: space-between;">`;
            // Witness 1
            html += `<div style="width: 45%;">`;
            html += `<div style="font-weight: bold; margin-bottom: 20px;">${t.pdfWitness1Label}:</div>`;
            html += `<div style="border-top: 1px solid #000; width: 100%; margin-bottom: 5px;"></div>`;
            html += `<div style="margin-bottom: 10px;">${currentLang === 'hi' ? '‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞' : 'Signature'}</div>`;
            html += `<div style="margin-bottom: 10px;">${currentLang === 'hi' ? '‡§®‡§æ‡§Æ' : 'Name'}: ___________________</div>`;
            html += `<div>${currentLang === 'hi' ? '‡§™‡§§‡§æ' : 'Address'}: _________________</div>`;
            html += `</div>`;

            // Witness 2
            html += `<div style="width: 45%;">`;
            html += `<div style="font-weight: bold; margin-bottom: 20px;">${t.pdfWitness2Label}:</div>`;
            html += `<div style="border-top: 1px solid #000; width: 100%; margin-bottom: 5px;"></div>`;
            html += `<div style="margin-bottom: 10px;">${currentLang === 'hi' ? '‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞' : 'Signature'}</div>`;
            html += `<div style="margin-bottom: 10px;">${currentLang === 'hi' ? '‡§®‡§æ‡§Æ' : 'Name'}: ___________________</div>`;
            html += `<div>${currentLang === 'hi' ? '‡§™‡§§‡§æ' : 'Address'}: _________________</div>`;
            html += `</div>`;

            html += `</div>`; // End flex
            html += `</div>`; // End signatures

            container.innerHTML = html;
        }

        // Beneficiaries
        function toggleBeneficiary(uniqueId) {
            const body = document.getElementById(`ben-body-${uniqueId}`);
            const row = document.getElementById(`ben-row-${uniqueId}`);

            if (body.classList.contains('hidden')) {
                document.querySelectorAll('[id^="ben-body-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.beneficiary-item').forEach(el => el.classList.remove('ring-2', 'ring-blue-100'));
                body.classList.remove('hidden');
                row.classList.add('ring-2', 'ring-blue-100');
            } else {
                body.classList.add('hidden');
                row.classList.remove('ring-2', 'ring-blue-100');
                saveData();
            }
        }

        function updateBeneficiaryHeader(uniqueId) {
            const t = TRANSLATIONS[currentLang];
            const row = document.getElementById(`ben-row-${uniqueId}`);
            if (!row) return;

            // Skip mobile summary cards (they are re-rendered by reloadDynamicRows)
            if (row.classList.contains('ben-summary-card')) return;

            const nameInput = document.getElementById(`ben-name-${uniqueId}`);
            if (!nameInput) return; // Safety check

            const nameVal = nameInput.value.trim();
            let relVal = document.getElementById(`ben-rel-${uniqueId}`).value.trim();

            // Translate common relationship terms
            if (currentLang === 'hi' && relVal) {
                const relMap = {
                    'son': '‡§¨‡•á‡§ü‡§æ', 'daughter': '‡§¨‡•á‡§ü‡•Ä', 'wife': '‡§™‡§§‡•ç‡§®‡•Ä', 'husband': '‡§™‡§§‡§ø',
                    'brother': '‡§≠‡§æ‡§à', 'sister': '‡§¨‡§π‡§®', 'mother': '‡§Æ‡§æ‡§Å', 'father': '‡§™‡§ø‡§§‡§æ',
                    'friend': '‡§Æ‡§ø‡§§‡•ç‡§∞', 'nephew': '‡§≠‡§§‡•Ä‡§ú‡§æ', 'niece': '‡§≠‡§§‡•Ä‡§ú‡•Ä'
                };
                const lowerRel = relVal.toLowerCase();
                if (relMap[lowerRel]) relVal = relMap[lowerRel];
            }

            row.querySelector('.ben-title-display').innerText = nameVal || t.dynNewBeneficiary;
            row.querySelector('.ben-desc-display').innerText = relVal || t.dynExpandDetails;
            row.querySelector('.ben-icon-display').innerText = nameVal ? nameVal.charAt(0).toUpperCase() : '+';
            saveData();
        }

        function updateAllHeaders() {
            // Update all beneficiary headers
            document.querySelectorAll('[id^="ben-row-"]').forEach(row => {
                const id = row.id.replace('ben-row-', '');
                updateBeneficiaryHeader(id);
            });

            // Update all asset headers
            document.querySelectorAll('[id^="asset-row-"]').forEach(row => {
                const id = row.id.replace('asset-row-', '');
                updateAssetHeader(id);
            });
        }

        function toggleGuardianSection(uniqueId) {
            const chk = document.getElementById(`ben-minor-${uniqueId}`);
            const div = document.getElementById(`guardian-div-${uniqueId}`);
            if (chk.checked) div.classList.remove('hidden'); else div.classList.add('hidden');
            saveData();
        }

        function addBeneficiaryRow(data = null) {
            beneficiaryCount++;

            const t = TRANSLATIONS[currentLang]; // Get translations

            if (isMobile()) {
                if (data) {
                    console.log(`[AddBeneficiaryRow] Calling renderBenSummaryCard with data.id: ${data.id}, beneficiaryCount: ${beneficiaryCount}`);
                    // CRITICAL: Use the ID from data, not beneficiaryCount
                    renderBenSummaryCard(data.id, data);
                } else {
                    openBenSheet();
                }
                return;
            }

            document.querySelectorAll('[id^="ben-body-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.beneficiary-item').forEach(el => el.classList.remove('ring-2', 'ring-blue-100'));

            const uniqueId = data ? data.id : generateUniqueId();
            const container = document.getElementById('beneficiary-container');

            const html = `
                <div id="ben-row-${uniqueId}" class="beneficiary-item bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transition-all duration-300 ring-2 ring-blue-100" data-id="${uniqueId}">
                    <div class="bg-white p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none" onclick="toggleBeneficiary('${uniqueId}')">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-xl ben-icon-display">${data ? data.name.charAt(0).toUpperCase() : '+'}</div>
                             <div>
                                 <h3 class="font-bold text-gray-800 text-sm ben-title-display">${data ? data.name : t.dynNewBeneficiary}</h3>
                                 <p class="text-xs text-gray-500 ben-desc-display truncate">${data && data.rel ? t.dynRelation + ': ' + data.rel : t.dynExpandDetails}</p>
                             </div>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${t.dynEdit}</span>
                             <button type="button" onclick="event.stopPropagation(); window.removeBeneficiaryRow('${uniqueId}')" class="text-gray-400 hover:text-red-500 p-1 hover:bg-red-50 rounded transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>

                    <!-- Flat Body, No Nested Boxes -->
                    <div id="ben-body-${uniqueId}" class="border-t border-gray-100 p-4 md:p-6 bg-slate-50 ${data ? 'hidden' : ''}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynFullName}</label>
                                <input type="text" id="ben-name-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynFullName}" oninput="updateBeneficiaryHeader('${uniqueId}')" value="${data ? data.name : ''}">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynRelationship}</label>
                                <input type="text" id="ben-rel-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhRelationship}" oninput="updateBeneficiaryHeader('${uniqueId}')" value="${data ? data.rel : ''}">
                            </div>
                        </div>
                        
                        <!-- Added Address -->
                        <div class="mb-4">
                            <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynPermAddress}</label>
                            <textarea id="ben-addr-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" rows="2" placeholder="${t.dynPhAddress}" oninput="saveData()">${data ? data.addr : ''}</textarea>
                        </div>

                        <!-- ID Info (Flat) -->
                        <div class="mb-6">
                            <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynParentSpouse}</label>
                             <div class="flex gap-2">
                                 <select id="ben-relPrefix-${uniqueId}" onchange="saveData()" class="w-28 border p-2 rounded text-sm bg-white text-gray-600 outline-none">
                                     <option value="S/o" ${data && data.relPrefix === 'S/o' ? 'selected' : ''}>${t.optSonOf}</option>
                                     <option value="D/o" ${data && data.relPrefix === 'D/o' ? 'selected' : ''}>${t.optDaughterOf}</option>
                                     <option value="W/o" ${data && data.relPrefix === 'W/o' ? 'selected' : ''}>${t.optWifeOf}</option>
                                 </select>
                                 <input type="text" id="ben-father-${uniqueId}" value="${data ? escapeHtml(data.father) : ''}" class="w-full border p-2 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="${t.dynPhName}" oninput="saveData()">
                             </div>
                        </div>

                        <!-- Options -->
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide block mb-1">${t.dynDefaultAlternate}</label>
                                <select id="ben-defaultAlt-${uniqueId}" class="w-full border p-2 rounded text-sm bg-white text-gray-600 outline-none" onchange="saveData()">
                                    <option value="">-- ${t.dynDefaultAlternate} --</option>
                                </select>
                            </div>
                            <div class="flex items-center mt-6">
                                <input type="checkbox" id="ben-minor-${uniqueId}" class="w-4 h-4 text-blue-600 rounded" onchange="toggleGuardianSection('${uniqueId}')" ${data && data.isMinor ? 'checked' : ''}>
                                <label for="ben-minor-${uniqueId}" class="ml-2 text-sm text-gray-700 font-bold select-none cursor-pointer">${t.dynIsMinor}</label>
                            </div>
                         </div>

                         <!-- Guardian Section (Clean) -->
                         <div id="guardian-div-${uniqueId}" class="mt-3 pt-3 border-t border-gray-200 ${data && data.isMinor ? '' : 'hidden'}">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynGuardianName}</label>
                                    <input type="text" id="guardian-name-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhGuardianName}" value="${data ? data.gName : ''}" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynGuardianRel}</label>
                                    <input type="text" id="guardian-rel-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhGuardianRel}" value="${data ? data.gRel : ''}" oninput="saveData()">
                                </div>
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynGuardianParent}</label>
                                     <div class="flex gap-2">
                                         <select id="ben-gRelPrefix-${uniqueId}" onchange="saveData()" class="w-28 border p-2 rounded text-sm bg-white text-gray-600 outline-none">
                                             <option value="S/o" ${data && data.gRelPrefix === 'S/o' ? 'selected' : ''}>${t.optSonOf}</option>
                                             <option value="D/o" ${data && data.gRelPrefix === 'D/o' ? 'selected' : ''}>${t.optDaughterOf}</option>
                                             <option value="W/o" ${data && data.gRelPrefix === 'W/o' ? 'selected' : ''}>${t.optWifeOf}</option>
                                         </select>
                                         <input type="text" id="guardian-father-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhName}" value="${data ? data.gFather : ''}" oninput="saveData()">
                                     </div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynGuardianAddress}</label>
                                    <input type="text" id="guardian-addr-${uniqueId}" class="w-full border p-2 rounded text-sm outline-none" placeholder="${t.dynPhGuardianAddress}" value="${data ? data.gAddr : ''}" oninput="saveData()">
                                </div>
                             </div>
                         </div>

                        <div class="text-center mt-6">
                            <button onclick="toggleBeneficiary('${uniqueId}')" class="text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 px-8 py-2 rounded shadow transition">Done & Collapse</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            if (data) {
                document.getElementById(`ben-defaultAlt-${uniqueId}`).setAttribute('data-selected', data.defaultAltId || '');
                if (data.relPrefix) document.getElementById(`ben-relPrefix-${uniqueId}`).value = data.relPrefix;
                if (data.gRelPrefix) document.getElementById(`ben-gRelPrefix-${uniqueId}`).value = data.gRelPrefix;
            }
            // Removed saveData() - will save when user actually enters data
        }

        function validateAndMoveToAssets() {
            // Check for both desktop and mobile beneficiaries
            const desktopBens = document.querySelectorAll('.beneficiary-item:not(.ben-summary-card)');
            const mobileBens = document.querySelectorAll('.ben-summary-card');
            const totalBens = desktopBens.length + mobileBens.length;

            if (totalBens === 0) {
                alert(t.errAddBen || "Please add at least one beneficiary.");
                return;
            }

            let isValid = true;

            // Validate desktop beneficiaries
            desktopBens.forEach(row => {
                const uid = row.getAttribute('data-id');
                const name = document.getElementById(`ben-name-${uid}`).value.trim();
                const rel = document.getElementById(`ben-rel-${uid}`).value.trim();
                if (!name || !rel) {
                    document.getElementById(`ben-body-${uid}`).classList.remove('hidden');
                    if (!name) document.getElementById(`ben-name-${uid}`).classList.add('error-border');
                    if (!rel) document.getElementById(`ben-rel-${uid}`).classList.add('error-border');
                    isValid = false;
                } else {
                    document.getElementById(`ben-name-${uid}`).classList.remove('error-border');
                    document.getElementById(`ben-rel-${uid}`).classList.remove('error-border');
                }
            });

            // Mobile beneficiaries are always valid (sheet enforces required fields)

            if (isValid) {
                updateMaxReached(4);
                goToStep(4);
            }
            if (document.getElementById('asset-container').children.length === 0) addAssetRow(true);
            if (document.getElementById('residual-shares-list').children.length === 0) addResidualShare();
        }

        // ASSETS
        function toggleAsset(uniqueId) {
            const body = document.getElementById(`asset-body-${uniqueId}`);
            const row = document.getElementById(`asset-row-${uniqueId}`);
            if (body.classList.contains('hidden')) {
                document.querySelectorAll('[id^="asset-body-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.asset-item').forEach(el => el.classList.remove('ring-2', 'ring-indigo-100'));
                body.classList.remove('hidden');
                row.classList.add('ring-2', 'ring-indigo-100');
            } else {
                body.classList.add('hidden');
                row.classList.remove('ring-2', 'ring-indigo-100');
            }
        }

        function updateAssetHeader(uniqueId) {
            const t = TRANSLATIONS[currentLang];
            const row = document.getElementById(`asset-row-${uniqueId}`);
            if (!row) return;

            // Skip mobile summary cards (they are re-rendered by reloadDynamicRows)
            if (row.classList.contains('asset-summary-card')) return;

            const typeSelect = row.querySelector('.asset-type-select');
            if (!typeSelect) return; // Safety check
            const inputs = row.querySelectorAll('.dynamic-field-input');
            let desc = "";
            inputs.forEach(inp => { if (inp.value) desc += inp.value + " "; });

            const typeVal = typeSelect.value;
            row.querySelector('.asset-icon-display').innerText = ASSET_ICONS[typeVal] || 'üìÑ';
            row.querySelector('.asset-title-display').innerText = typeVal ? typeSelect.options[typeSelect.selectedIndex].text : t.dynNewAsset;

            // Better UX: if type is selected but no description, show "Expand to add details"
            const sharesContainer = document.getElementById(`shares-container-${uniqueId}`);
            const benCount = sharesContainer ? sharesContainer.querySelectorAll('.share-row').length : 0;
            const benCountText = benCount > 0 ? ` ‚Ä¢ ${benCount} ${t.dynBeneficiaries}` : '';

            if (typeVal && !desc.trim()) {
                row.querySelector('.asset-desc-display').innerText = t.dynExpandDetails + benCountText;
            } else {
                row.querySelector('.asset-desc-display').innerText = (desc.trim() || t.dynSelectType) + benCountText;
            }
        }

        function addAssetRow(autoInit = false) {
            const t = TRANSLATIONS[currentLang]; // Get translations

            // Mobile: Open bottom sheet instead of accordion
            if (isMobile()) {
                assetCount++;
                // Don't auto-open sheet during page navigation (autoInit = true)
                // Only open when user explicitly clicks "Add Asset" button
                if (!autoInit) {
                    openAssetSheet(assetCount);
                }
                return;
            }

            // Desktop: Keep accordion behavior
            document.querySelectorAll('[id^="asset-body-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.asset-item').forEach(el => el.classList.remove('ring-2', 'ring-indigo-100'));

            assetCount++;
            const container = document.getElementById('asset-container');
            const uniqueId = assetCount;

            const html = `
                <div id="asset-row-${uniqueId}" class="asset-item bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transition-all duration-300 ring-2 ring-indigo-100">
                    <div class="bg-white p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none" onclick="toggleAsset(${uniqueId})">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xl asset-icon-display">?</div>
                             <div>
                                 <h3 class="font-bold text-gray-800 text-sm asset-title-display">${t.dynNewAsset}</h3>
                                 <p class="text-xs text-gray-500 asset-desc-display truncate max-w-xs md:max-w-md">${t.dynSelectType}</p>
                             </div>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">${t.dynEdit}</span>
                             <button type="button" onclick="event.stopPropagation(); window.removeSpecificRow(${uniqueId})" class="text-gray-400 hover:text-red-500 p-1 hover:bg-red-50 rounded transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>
                    <div id="asset-body-${uniqueId}" class="border-t border-gray-100 p-4 md:p-6 bg-slate-50">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4 shadow-sm">
                             <div class="mb-3">
                                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">${t.dynAssetType}</label>
                                <select class="asset-type-select w-full border p-2 rounded text-xs sm:text-sm bg-gray-50 outline-none transition" onchange="renderAssetFields(${uniqueId}, this.value); checkSplitWarning(${uniqueId}); updateAssetHeader(${uniqueId}); saveData()">
                                    <option value="">${t.dynSelectAssetType}</option>
                                    <optgroup label="${t.assetOptRealEstate}"><option value="flat">${t.assetOptFlat}</option><option value="land">${t.assetOptLand}</option><option value="shop">${t.assetOptShop}</option></optgroup>
                                    <optgroup label="${t.assetOptBankCash}"><option value="savings">${t.assetOptSavings}</option><option value="fd">${t.assetOptFD}</option><option value="locker">${t.assetOptLocker}</option><option value="loan">${t.assetOptLoan}</option></optgroup>
                                    <optgroup label="${t.assetOptInvestments}"><option value="nps">${t.assetOptNPS}</option><option value="mf">${t.assetOptMF}</option><option value="demat">${t.assetOptDemat}</option><option value="crypto">${t.assetOptCrypto}</option><option value="insurance">${t.assetOptInsurance}</option></optgroup>
                                    <optgroup label="${t.assetOptBusiness}"><option value="esop">${t.assetOptESOP}</option><option value="business">${t.assetOptBusinessInt}</option></optgroup>
                                    <optgroup label="${t.assetOptValuables}"><option value="jewelry">${t.assetOptJewelry}</option><option value="vehicle">${t.assetOptVehicle}</option></optgroup>
                                </select>
                             </div>
                             <div id="dynamic-fields-${uniqueId}"></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                             <div id="split-warning-${uniqueId}" class="hidden mb-3 bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r">
                                <div class="flex gap-2">
                                    <span class="text-xl">‚ö†Ô∏è</span>
                                    <p class="text-xs text-amber-900 leading-snug"><strong>${t.dynIndivisibleWarning.split(':')[0]}:</strong> ${t.dynIndivisibleWarning.split(':')[1]}</p>
                                </div>
                             </div>
                             <div id="shares-container-${uniqueId}" class="space-y-2"></div>
                             <button onclick="addShareRow(${uniqueId})" class="mt-3 text-xs flex items-center gap-1 bg-white border border-indigo-200 text-indigo-600 font-bold px-3 py-2 rounded hover:bg-indigo-50 transition">
                                ${t.dynAddShare}
                             </button>
                        </div>
                        <div class="text-center mt-6">
                            <button onclick="toggleAsset(${uniqueId})" class="text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 px-8 py-2 rounded shadow transition">${t.dynEdit === 'Edit' ? 'Done & Collapse' : '‡§™‡•Ç‡§∞‡•ç‡§£ ‡§î‡§∞ ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç'}</button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            addShareRow(uniqueId);
            // Removed saveData() - will save when user actually enters data
        }

        function renderAssetFields(uniqueId, type) {
            const container = document.getElementById(`dynamic-fields-${uniqueId}`);
            container.innerHTML = '';
            const schema = ASSET_SCHEMAS[type] || ASSET_SCHEMAS['jewelry'];
            schema.forEach(field => {
                const wrapper = document.createElement('div');
                wrapper.className = "mb-3";
                const label = document.createElement('label');
                label.className = "text-[10px] font-bold uppercase text-gray-500 block mb-1";
                label.innerText = field.label;
                let input;
                if (field.type === 'textarea') { input = document.createElement('textarea'); input.rows = 2; }
                else { input = document.createElement('input'); input.type = 'text'; }
                input.className = `dynamic-field-input w-full border p-2 rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none`;
                input.setAttribute('data-key', field.key);
                input.placeholder = field.label;
                input.oninput = function () { removeError(this); updateAssetHeader(uniqueId); saveData(); };
                wrapper.appendChild(label); wrapper.appendChild(input); container.appendChild(wrapper);
            });
        }

        function onPrimaryBenChange(selectEl) {
            const benId = selectEl.value; if (!benId) return;
            const ben = beneficiaries.find(b => b.id == benId);
            const altSelect = selectEl.closest('.share-row').querySelector('.ben-select-alt-share');
            if (ben && ben.defaultAltId) altSelect.value = ben.defaultAltId;
        }

        function onSheetBenChange(selectEl) {
            const benId = selectEl.value; if (!benId) return;
            const ben = beneficiaries.find(b => b.id == benId);
            const altSelect = selectEl.closest('.sheet-ben-row').querySelector('.sheet-alt-select');
            if (ben && ben.defaultAltId) altSelect.value = ben.defaultAltId;
        }

        function onResidualPrimaryBenChange(selectEl) {
            const benId = selectEl.value; if (!benId) return;
            const ben = beneficiaries.find(b => b.id == benId);
            const altSelect = selectEl.closest('.residual-row').querySelector('.residual-ben-alt-select');
            if (ben && ben.defaultAltId) altSelect.value = ben.defaultAltId;
        }

        function addShareRow(assetId, benId = '', shareVal = '', altId = '') {
            const t = TRANSLATIONS[currentLang]; // Get translations

            const container = document.getElementById(`shares-container-${assetId}`);

            // Auto-calculate share if not provided
            if (!shareVal) {
                let totalShare = 0;
                container.querySelectorAll('.share-input').forEach(input => {
                    totalShare += parseFloat(input.value) || 0;
                });
                const remaining = Math.max(0, 100 - totalShare);
                shareVal = remaining > 0 ? remaining : '';
            }
            const div = document.createElement('div');
            div.className = "share-row bg-gray-50 p-3 rounded border border-gray-200 mb-2 relative group hover:bg-white hover:shadow-sm transition-all";
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                    <div class="md:col-span-4">
                         <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynBeneficiaries}</label>
                         <select class="ben-select-share w-full border p-2 rounded text-sm bg-white focus:border-indigo-500 outline-none" onchange="onPrimaryBenChange(this); saveData()"></select>
                    </div>
                    <div class="md:col-span-2">
                         <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">${t.dynPercentShare}</label>
                         <div class="relative">
                            <input type="number" class="share-input w-full border p-2 rounded text-sm font-bold text-center bg-white outline-none" value="${shareVal}" min="1" max="100" oninput="saveData()">
                            <span class="absolute right-2 top-2 text-xs text-gray-400 font-bold">%</span>
                         </div>
                    </div>
                    <div class="md:col-span-5">
                         <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">${t.dynAlternate}</label>
                         <select class="ben-select-alt-share w-full border p-2 rounded text-sm bg-white text-gray-600 outline-none" onchange="saveData()"></select>
                    </div>
                    <div class="md:col-span-1 flex items-end justify-center h-full pb-1">
                         <button onclick="removeShareRow(this)" class="text-gray-300 hover:text-red-500 transition" title="Remove Share">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                         </button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            console.log(`[AddShareRow] Asset ${assetId}, Ben ${benId}. Beneficiaries count: ${beneficiaries.length}`);
            console.log(`[AddShareRow] Beneficiaries array:`, beneficiaries);
            populateDropdown(div.querySelector('.ben-select-share'));
            populateDropdown(div.querySelector('.ben-select-alt-share'));
            div.querySelector('.ben-select-share').value = String(benId || '');
            div.querySelector('.ben-select-alt-share').value = String(altId || '');
            div.querySelector('.ben-select-alt-share').value = String(altId || '');
            console.log(`[AddShareRow] Set dropdown value to ${benId}. Actual value: ${div.querySelector('.ben-select-share').value}`);
            checkSplitWarning(assetId);
            updateAssetHeader(assetId); // Update header count
            saveData();
        }

        function removeShareRow(btn) {
            const row = btn.closest('.share-row');
            const assetId = row.parentElement.id.split('-')[2];
            if (row.parentElement.children.length > 1) {
                row.remove();
                checkSplitWarning(assetId);
                updateAssetHeader(assetId); // Update header count
                saveData();
            }
            else alert(t.errAssetBenReq || "Asset must have at least one beneficiary.");
        }

        // Updated for Consistency

        // Function to reload all dynamic rows when language changes
        function reloadDynamicRows() {
            // 1. Collect Data
            const currentExecutors = collectExecutors();
            const currentBens = collectBeneficiaries();
            const currentAssets = collectAllAssets();
            const currentResiduals = collectResidualShares();

            // 2. Clear Containers
            document.getElementById('primary-executors-container').innerHTML = '';
            document.getElementById('alternate-executor-container').innerHTML = '';
            document.getElementById('beneficiary-container').innerHTML = '';
            document.getElementById('mobile-executor-cards-container').innerHTML = ''; // Clear mobile executor cards

            // Reload Executors
            executors = []; // Clear global executors array before re-populating
            executorCount = 0; // Reset counter
            currentExecutors.forEach(ex => {
                executorCount++;
                ex.id = executorCount; // Reassign IDs to ensure uniqueness and sequence
                executors.push(ex);
                renderExecutorRow(ex); // Render desktop view
            });
            renderExecutorSummaryCard(); // Render mobile view

            // Show/hide alternate button
            const hasAlternate = executors.some(e => !e.isPrimary);
            const altBtn = document.getElementById('btn-add-alternate');
            if (altBtn) {
                if (hasAlternate) altBtn.classList.add('hidden');
                else altBtn.classList.remove('hidden');
            }
            document.getElementById('asset-container').innerHTML = '';
            document.getElementById('residual-shares-list').innerHTML = '';

            // Reset counters
            beneficiaryCount = 0;
            assetCount = 0;

            // 3. Re-render Beneficiaries
            beneficiaries = []; // Clear global beneficiaries array
            currentBens.forEach(ben => {
                // CRITICAL FIX: Do NOT reassign IDs. Keep the timestamp IDs.
                // ben.id = beneficiaryCount; 
                beneficiaries.push(ben);
                addBeneficiaryRow(ben);
            });

            // 4. Re-render Assets
            currentAssets.forEach(asset => {
                if (isMobile()) {
                    // Mobile: Render Summary Card
                    assetCount++;
                    const newId = assetCount;
                    asset.id = newId;
                    renderMobileSummaryCard(newId, asset.type, asset.shares, asset.details);
                } else {
                    // Desktop: Add Row and Populate
                    addAssetRow();
                    const assetId = assetCount;

                    // Populate Asset Type
                    const typeSelect = document.querySelector(`#asset-row-${assetId} .asset-type-select`);
                    if (typeSelect) {
                        typeSelect.value = asset.type;
                        renderAssetFields(assetId, asset.type);
                    }

                    // Populate Fields
                    const assetBody = document.getElementById(`asset-body-${assetId}`);
                    if (assetBody) {
                        // Populate inputs
                        const schema = ASSET_SCHEMAS[asset.type] || [];
                        schema.forEach(field => {
                            const input = assetBody.querySelector(`.dynamic-field-input[data-key="${field.key}"]`);
                            if (input && asset.details && asset.details[field.key]) {
                                input.value = asset.details[field.key];
                            }
                        });
                        updateAssetHeader(assetId);

                        // Populate Shares
                        const sharesContainer = document.getElementById(`shares-container-${assetId}`);
                        if (sharesContainer) {
                            sharesContainer.innerHTML = ''; // Clear default empty share
                            asset.shares.forEach(share => {
                                addShareRow(assetId, share.benId, share.share, share.altId);
                            });
                        }
                    }
                }
            });

            // 5. Re-render Residuals
            document.getElementById('residual-shares-list').innerHTML = ''; // Clear existing
            currentResiduals.forEach(res => {
                addResidualShare(res.benId, res.share, res.altId);
            });

            updateAllDropdowns();
        }

        function addResidualShare(benId = '', share = '', altId = '') {
            // Auto-calculate share if not provided
            if (!share) {
                const existingShares = collectResidualShares();
                let totalShare = 0;
                existingShares.forEach(s => totalShare += parseFloat(s.share) || 0);
                const remaining = Math.max(0, 100 - totalShare);
                share = remaining > 0 ? remaining : '';
            }

            // Mobile Logic
            if (isMobile()) {
                if (benId) {
                    // Loading data - render summary card
                    // Use random component to avoid collision during rapid re-rendering
                    const uniqueId = generateUniqueId();
                    const data = { id: uniqueId, benId, share, altId };
                    renderResidualSummaryCard(data.id, data);
                }
                // Don't auto-open sheet when called without benId (e.g., during page navigation)
                // User should explicitly click "Add" button to open the sheet
                return;
            }

            // Desktop Logic
            const container = document.getElementById('residual-shares-list');
            const div = document.createElement('div');
            // Matches Share Row UI
            div.className = "residual-row bg-gray-50 p-3 rounded border border-gray-200 mb-2 relative group hover:bg-white hover:shadow-sm transition-all";
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                    <div class="md:col-span-4">
                         <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">Beneficiary</label>
                         <select class="residual-ben-select w-full border p-2 rounded text-sm bg-white focus:border-indigo-500 outline-none" onchange="onResidualPrimaryBenChange(this); saveData()"></select>
                    </div>
                    <div class="md:col-span-2">
                         <label class="text-[10px] font-bold uppercase text-gray-500 block mb-1">% Share</label>
                         <div class="relative">
                            <input type="number" class="residual-share-input w-full border p-2 rounded text-sm font-bold text-center bg-white outline-none" value="${share}" min="1" max="100" oninput="saveData()">
                            <span class="absolute right-2 top-2 text-xs text-gray-400 font-bold">%</span>
                         </div>
                    </div>
                    <div class="md:col-span-5">
                         <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Alternate</label>
                         <select class="residual-ben-alt-select w-full border p-2 rounded text-sm bg-white text-gray-600 outline-none" onchange="saveData()"></select>
                    </div>
                    <div class="md:col-span-1 flex items-end justify-center h-full pb-1">
                         <button onclick="this.closest('.residual-row').remove(); saveData()" class="text-gray-300 hover:text-red-500 transition" title="Remove Share">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                         </button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            populateDropdown(div.querySelector('.residual-ben-select'));
            populateDropdown(div.querySelector('.residual-ben-alt-select'));
            div.querySelector('.residual-ben-select').value = benId;
            div.querySelector('.residual-ben-alt-select').value = altId;
            // Removed saveData() - will save when user actually enters data
        }

        function checkSplitWarning(assetId) {
            const row = document.getElementById(`asset-row-${assetId}`);
            const type = row.querySelector('.asset-type-select').value;
            const shareCount = row.querySelectorAll('.share-row').length;
            const indivisible = ['flat', 'land', 'shop', 'vehicle', 'jewelry'];
            if (indivisible.includes(type) && shareCount > 1) document.getElementById(`split-warning-${assetId}`).classList.remove('hidden');
            else document.getElementById(`split-warning-${assetId}`).classList.add('hidden');
        }

        function updateAllDropdowns() {
            document.querySelectorAll('.ben-select-share, .ben-select-alt-share, .residual-ben-select, .residual-ben-alt-select, [id^="ben-defaultAlt-"]').forEach(sel => {
                const currentVal = sel.value || sel.getAttribute('data-selected') || '';
                const isInternalAlt = sel.id.startsWith('ben-defaultAlt-');
                let selfId = isInternalAlt ? sel.id.replace('ben-defaultAlt-', '') : null;
                sel.innerHTML = '<option value="">' + (isInternalAlt ? '-- No Default Alternate --' : 'Select...') + '</option>';
                beneficiaries.forEach(b => {
                    if (isInternalAlt && String(b.id) === String(selfId)) return;
                    const o = document.createElement('option'); o.value = b.id; o.innerText = b.name; sel.appendChild(o)
                });
                sel.value = currentVal;
            });
        }

        function populateDropdown(sel) {
            sel.innerHTML = '<option value="">Select...</option>';
            beneficiaries.forEach(b => {
                const o = document.createElement('option');
                o.value = String(b.id); // Ensure ID is string
                o.innerText = b.name;
                sel.appendChild(o);
            });
        }

        function saveData() {
            // Immediately sync executors from DOM to global array
            // This ensures data is available for validation and language changes
            collectExecutors();

            const statusEl = document.getElementById('save-status');
            statusEl.innerText = "SAVING..."; statusEl.classList.remove('bg-green-600'); statusEl.classList.add('bg-yellow-500');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { performSave(); statusEl.innerText = "SAVED"; statusEl.classList.remove('bg-yellow-500'); statusEl.classList.add('bg-green-600'); const t = document.getElementById('save-toast'); t.innerText = "Draft Saved"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }, 1000);
        }

        function performSave() {
            const scrapedBens = collectBeneficiaries();
            console.log('[PerformSave] Scraped beneficiaries from DOM. IDs:', scrapedBens.map(b => b.id));
            beneficiaries = scrapedBens;
            updateAllDropdowns();

            const residualShares = [];

            // 1. Desktop Residual Rows
            document.querySelectorAll('.residual-row').forEach(row => {
                residualShares.push({
                    benId: row.querySelector('.residual-ben-select').value,
                    share: row.querySelector('.residual-share-input').value,
                    altId: row.querySelector('.residual-ben-alt-select').value
                });
            });

            // 2. Mobile Residual Summary Cards
            document.querySelectorAll('.residual-summary-card').forEach(card => {
                const dataDiv = card.querySelector('.residual-data');
                if (dataDiv) {
                    const data = JSON.parse(dataDiv.getAttribute('data-json') || '{}');
                    if (data.benId) {
                        residualShares.push({
                            benId: data.benId,
                            share: data.share,
                            altId: data.altId
                        });
                    }
                }
            });

            const data = {
                lastStep: lastActiveStep,
                maxStep: maxReachedStep,
                language: currentLang, // Save language preference
                personal: {
                    religion: document.getElementById('religionSelector').value,
                    customReligion: document.getElementById('customReligion').value,
                },
                myName: document.getElementById('myName').value,
                myRelPrefix: document.getElementById('myRelPrefix').value,
                fatherName: document.getElementById('fatherName').value,
                myDob: document.getElementById('myDob').value,
                myAddress: document.getElementById('myAddress').value,
                myPlace: document.getElementById('myPlace').value,
                myPlace: document.getElementById('myPlace').value,
                executors: collectExecutors(),
                beneficiaries,
                assets: [],
                residual: residualShares
            };

            // Collect assets from both desktop and mobile views
            const allAssets = collectAllAssets();
            data.assets = allAssets.map(asset => {
                // Generate description string for RTF/PDF
                let descString = "";
                Object.entries(asset.details).forEach(([key, value]) => {
                    if (value) {
                        const schema = ASSET_SCHEMAS[asset.type];
                        const field = schema?.find(f => f.key === key);
                        const label = field?.label || key;
                        descString += `${label}: ${value}, `;
                    }
                });
                if (descString.length > 2) descString = descString.substring(0, descString.length - 2);

                return {
                    type: asset.type,
                    desc: descString,
                    details: asset.details,
                    shares: asset.shares
                };
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                console.log('[LoadData] No data in localStorage');
                return;
            }

            let data;
            try {
                data = JSON.parse(raw);
                console.log('[LoadData] Data loaded from localStorage:', data);
            } catch (e) {
                // Corrupted data, clear it
                console.error('[LoadData] Corrupted data, clearing:', e);
                localStorage.removeItem(STORAGE_KEY);
                return;
            }

            // Only show resume banner if there's actually meaningful data
            const hasData = data.myName ||
                (data.beneficiaries && data.beneficiaries.length > 0) ||
                (data.assets && data.assets.length > 0);

            if (!hasData) {
                // No meaningful data, clear storage and don't show resume banner
                localStorage.removeItem(STORAGE_KEY);
                return;
            }

            document.getElementById('resume-banner').classList.remove('hidden');
            const startBtn = document.getElementById('start-btn-container'); if (startBtn) startBtn.style.display = 'none';

            const sV = (id, v) => { if (document.getElementById(id)) document.getElementById(id).value = v || ''; };
            sV('religionSelector', data.personal.religion); sV('customReligion', data.personal.customReligion);
            sV('myName', data.myName); sV('myRelPrefix', data.myRelPrefix || 'S/o'); sV('fatherName', data.fatherName); sV('myDob', data.myDob); sV('myAddress', data.myAddress); sV('myPlace', data.myPlace);
            sV('religionSelector', data.personal.religion); sV('customReligion', data.personal.customReligion);
            sV('myName', data.myName); sV('myRelPrefix', data.myRelPrefix || 'S/o'); sV('fatherName', data.fatherName); sV('myDob', data.myDob); sV('myAddress', data.myAddress); sV('myPlace', data.myPlace);

            // Load Executors
            document.getElementById('primary-executors-container').innerHTML = '';
            document.getElementById('alternate-executor-container').innerHTML = '';
            document.getElementById('mobile-executor-cards-container').innerHTML = ''; // Clear mobile executor cards
            executors = [];
            executorCount = 0;

            if (data.executors && data.executors.length > 0) {
                executors = data.executors;
                executorCount = Math.max(...executors.map(e => e.id));
                executors.forEach(ex => renderExecutorRow(ex));
                renderExecutorSummaryCard(); // Update mobile summary
            } else if (data.exName) {
                // Migration: Convert legacy single executor to new format
                addExecutorRow(true); // Adds a primary executor
                const ex = executors[0];
                ex.name = data.exName;
                ex.relationship = data.exRel;
                ex.address = data.exAddress;
                ex.parentName = (data.exRelPrefix || '') + ' ' + (data.exParentName || '');

                // Re-render to show data
                document.getElementById('primary-executors-container').innerHTML = '';
                renderExecutorRow(ex);
                renderExecutorSummaryCard(); // Update mobile summary
            } else {
                // No executors, add one empty primary row by default
                addExecutorRow(true);
            }

            document.getElementById('beneficiary-container').innerHTML = '';
            beneficiaryCount = 0;

            if (data.beneficiaries && data.beneficiaries.length > 0) {
                // CRITICAL: Set global beneficiaries array FIRST before rendering
                // This ensures dropdowns in assets can find beneficiaries
                beneficiaries = data.beneficiaries;

                console.log('[LoadData] Beneficiaries from localStorage:', data.beneficiaries.map(b => ({ id: b.id, type: typeof b.id })));

                // Render each beneficiary card
                data.beneficiaries.forEach(b => {
                    addBeneficiaryRow(b);
                });

                // DEBUG: Check what's actually in the DOM
                setTimeout(() => {
                    const cards = document.querySelectorAll('.ben-summary-card');
                    console.log('[LoadData] Beneficiary cards in DOM after rendering:',
                        Array.from(cards).map(c => c.id));
                }, 100);
            }
            checkReligion();

            const ac = document.getElementById('asset-container'); ac.innerHTML = ''; assetCount = 0;
            console.log('[LoadData] Starting asset loading. Assets count:', data.assets ? data.assets.length : 0);
            if (data.assets) {
                isLoadingData = true; // Prevent bottom sheet from opening during data load
                console.log('[LoadData] About to iterate through assets. Array:', data.assets);
                data.assets.forEach(a => {
                    console.log('[LoadData] Processing asset:', a);
                    assetCount++;
                    const assetId = assetCount;

                    const mobileCheck = isMobile();
                    console.log(`[LoadData] isMobile() = ${mobileCheck}, window.innerWidth = ${window.innerWidth}`);

                    if (mobileCheck) {
                        // Restore as mobile summary card
                        // Reconstruct beneficiaries for summary card
                        const bens = a.shares ? a.shares.map(s => ({
                            benId: s.benId,
                            share: s.share,
                            altId: s.altId
                        })) : [];

                        renderMobileSummaryCard(assetId, a.type, bens, a.details || {});
                    } else {
                        // Desktop path
                        console.log(`[LoadData] Processing desktop asset ${assetId}, type: ${a.type}`);

                        try {
                            // Reset assetCount because addAssetRow increments it
                            assetCount--;
                            addAssetRow();

                            const row = ac.lastElementChild;
                            console.log(`[LoadData] Created row for asset ${assetId}`);

                            row.querySelector('.asset-type-select').value = a.type;
                            renderAssetFields(assetId, a.type);
                            if (a.details) { Object.keys(a.details).forEach(key => { const inp = row.querySelector(`[data-key="${key}"]`); if (inp) inp.value = a.details[key]; }); }
                            document.getElementById(`shares-container-${assetId}`).innerHTML = '';
                            console.log(`[LoadData] Adding shares for asset ${assetId}. Shares:`, a.shares);
                            if (a.shares) {
                                a.shares.forEach(s => {
                                    console.log(`[LoadData] Adding share row: Asset ${assetId}, Ben ${s.benId}`);
                                    addShareRow(assetId, s.benId, s.share, s.altId);
                                });
                            } else {
                                addShareRow(assetId);
                            }
                            updateAssetHeader(assetId); checkSplitWarning(assetId);
                            document.getElementById(`asset-body-${assetId}`).classList.add('hidden');
                            document.getElementById(`asset-row-${assetId}`).classList.remove('ring-2', 'ring-indigo-100');
                        } catch (error) {
                            console.error(`[LoadData] Error loading asset ${assetId}:`, error);
                        }
                    }
                });
                isLoadingData = false; // Re-enable bottom sheet
            }
            document.getElementById('residual-shares-list').innerHTML = '';
            if (Array.isArray(data.residual)) data.residual.forEach(r => addResidualShare(r.benId, r.share, r.altId)); else addResidualShare();
            updateAllDropdowns(); savedStepIndex = data.lastStep || 1;
            maxReachedStep = data.maxStep !== undefined ? data.maxStep : (data.lastStep || 0);

            // Restore language preference
            if (data.language) {
                currentLang = data.language;
            }
        }

        function finishJourney() {
            const assets = document.querySelectorAll('.asset-item'); let isValid = true;
            assets.forEach(row => {
                const uniqueId = row.id.replace('asset-row-', '');
                let totalShare = 0;
                row.querySelectorAll('.share-row').forEach(sr => {
                    const bId = sr.querySelector('.ben-select-share').value; const share = parseFloat(sr.querySelector('.share-input').value) || 0;
                    if (!bId) { document.getElementById(`asset-body-${uniqueId}`).classList.remove('hidden'); sr.querySelector('.ben-select-share').classList.add('error-border'); isValid = false; }
                    totalShare += share;
                });
                if (totalShare !== 100) { document.getElementById(`asset-body-${uniqueId}`).classList.remove('hidden'); alert(t.errTotalShare || `Error: Total share must be 100%.`); isValid = false; return; }
            });

            let residualTotal = 0; let hasResBen = false;

            // 1. Desktop Residual Rows
            document.querySelectorAll('.residual-row').forEach(row => {
                if (row.querySelector('.residual-ben-select').value) hasResBen = true;
                residualTotal += parseFloat(row.querySelector('.residual-share-input').value) || 0;
            });

            // 2. Mobile Residual Summary Cards
            document.querySelectorAll('.residual-summary-card').forEach(card => {
                const dataDiv = card.querySelector('.residual-data');
                if (dataDiv) {
                    const data = JSON.parse(dataDiv.getAttribute('data-json') || '{}');
                    if (data.benId) hasResBen = true;
                    residualTotal += parseFloat(data.share) || 0;
                }
            });

            if (!hasResBen) { alert(t.errResidualReq || "Please select at least one Residual Beneficiary."); closePreview(); goToStep(4); return; }
            if (residualTotal !== 100) { alert(t.errResidualTotal || `Residual shares must total 100%.`); closePreview(); goToStep(4); return; }
            if (!isValid) { closePreview(); goToStep(4); return; }

            performSave(); // Force save before generation

            // Just show the success overlay with options, do not auto-generate PDF
            updateMaxReached(5);
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            document.getElementById('preview-overlay').classList.add('hidden');
            document.getElementById('success-overlay').classList.remove('hidden');
            updateProgressBar(5);

            // Explicitly set PDF button visibility based on current language
            const btnPdf = document.getElementById('btn-download-pdf');
            if (btnPdf) {
                if (currentLang === 'hi') {
                    btnPdf.classList.add('hidden');
                } else {
                    btnPdf.classList.remove('hidden');
                }
            }

            window.scrollTo(0, 0);
        }

        async function generatePDF() {
            if (currentLang === 'hi') {
                alert(t.errPdfHindi || "PDF generation is currently not supported for Hindi. Please download the Editable (.rtf) version.");
                return;
            }
            const t = TRANSLATIONS[currentLang]; // Define translation helper
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const margin = 25, topMargin = 25, bottomMargin = 35, pageWidth = 210, contentWidth = pageWidth - (margin * 2), lineHeight = 6;
            let y = topMargin;

            const checkY = (h) => { if (y + h > (297 - bottomMargin)) { doc.addPage(); y = topMargin; } };
            const printBlock = (text, isBold = false) => {
                doc.setFont("times", isBold ? "bold" : "normal"); doc.setFontSize(12);
                const lines = doc.splitTextToSize(text, contentWidth);
                checkY(lines.length * lineHeight); doc.text(lines, margin, y); y += (lines.length * lineHeight) + 2;
            };
            const printSectionHeader = (text) => { y += 5; checkY(10); doc.setFont("times", "bold"); doc.setFontSize(14); doc.text(text, margin, y); y += 8; };
            const printAssetDetail = (label, value) => {
                doc.setFontSize(12); doc.setFont("times", "bold"); const lw = doc.getTextWidth(label + ": ");
                checkY(lineHeight); doc.text(label + ":", margin + 5, y); doc.setFont("times", "normal");
                const valLines = doc.splitTextToSize(value, contentWidth - 5 - lw); doc.text(valLines, margin + 5 + lw, y); y += (valLines.length * lineHeight);
            };

            const gV = (id) => document.getElementById(id).value;
            const gB = (id) => beneficiaries.find(b => b.id == id);
            const rShares = collectResidualShares();

            doc.setFont("times", "bold"); doc.setFontSize(22); doc.text("LAST WILL AND TESTAMENT", pageWidth / 2, y, { align: 'center' }); y += 8;
            doc.setLineWidth(0.5); doc.line(margin, y, pageWidth - margin, y); y += 15;

            let religionTxt = gV('religionSelector'); if (religionTxt === 'Other') religionTxt = gV('customReligion') || 'Other';

            const myName = gV('myName').toUpperCase();
            const fatherName = gV('fatherName').trim();
            const myRelPrefix = gV('myRelPrefix') || 'S/o';
            const myDobVal = gV('myDob');

            let preamble = `I, ${myName}`;
            if (fatherName) preamble += `, ${myRelPrefix} ${fatherName}`;

            if (myDobVal) {
                const dobDate = new Date(myDobVal);
                const dobStr = dobDate.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
                preamble += `, born on ${dobStr}`;
            }

            preamble += `, residing at ${gV('myAddress')} (Religion: ${religionTxt}), being of sound mind and memory, do hereby make, publish and declare this to be my Last Will and Testament.`;
            printBlock(preamble);

            printSectionHeader("1. REVOCATION OF PRIOR WILLS");
            printBlock(`I hereby revoke all former Wills and Codicils made by me. I declare I am in good health and sound mind, making this Will voluntarily.`);

            printSectionHeader("2. APPOINTMENT OF EXECUTOR");

            // Ensure we have the latest executor data
            const currentExecutors = collectExecutors();
            const primaryExecutors = currentExecutors.filter(e => e.isPrimary);
            const alternateExecutor = currentExecutors.find(e => !e.isPrimary);

            if (primaryExecutors.length > 0) {
                // Only show "Primary Executor(s)" heading when alternate exists (to distinguish from alternate)
                if (alternateExecutor) {
                    checkY(10);
                    doc.setFont("times", "bold"); doc.setFontSize(12);
                    doc.text(t.previewPrimaryExecutors, margin, y); y += 6;
                    doc.setFont("times", "normal");
                }

                if (primaryExecutors.length === 1) {
                    const ex = primaryExecutors[0];
                    let execText = `I appoint ${ex.name.toUpperCase()} (Rel: ${ex.relationship})`;
                    if (ex.parentName) execText += `, ${ex.parentName}`;
                    if (ex.address) execText += `, residing at ${ex.address}`;
                    execText += `, to be the sole Executor of this Will.`;
                    printBlock(execText);
                } else {
                    printBlock("I appoint the following person(s) as the Executor(s) of this Will:");
                    primaryExecutors.forEach((ex, index) => {
                        let execText = `(${String.fromCharCode(97 + index)}) ${ex.name.toUpperCase()} (Rel: ${ex.relationship})`;
                        if (ex.parentName) execText += `, ${ex.parentName}`;
                        if (ex.address) execText += `, residing at ${ex.address}`;

                        // Manual indentation logic
                        const lines = doc.splitTextToSize(execText, contentWidth - 10);
                        checkY(lines.length * lineHeight);
                        doc.text(lines, margin + 10, y);
                        y += (lines.length * lineHeight) + 2;
                    });
                    doc.setFont("times", "italic");
                    printBlock("The Executors shall act jointly and severally.");
                    doc.setFont("times", "normal");
                }
            }

            if (alternateExecutor) {
                y += 6;
                checkY(10);
                doc.setFont("times", "bold"); doc.setFontSize(12);
                doc.text(t.previewAlternateExecutor, margin, y); y += 6;
                doc.setFont("times", "normal");

                printBlock("If the above Executor(s) are unable or unwilling to act, I appoint the following person as Alternate Executor:");
                let altText = `${alternateExecutor.name.toUpperCase()} (Rel: ${alternateExecutor.relationship})`;
                if (alternateExecutor.parentName) altText += `, ${alternateExecutor.parentName}`;
                altText += `, residing at ${alternateExecutor.address}.`;
                printBlock(altText);
            }

            printSectionHeader("3. DISTRIBUTION OF ASSETS");
            doc.setFont("times", "normal"); doc.setFontSize(12); doc.text("I bequeath my assets as follows:", margin, y); y += 8;

            const assets = JSON.parse(localStorage.getItem(STORAGE_KEY)).assets || [];
            const getBenString = (b) => {
                if (!b) return "Unknown";
                let s = `${b.name} (${b.rel})`;
                if (b.addr) s += `, R/o ${b.addr}`;
                if (b.father && b.father.trim()) s += `, ${b.relPrefix || 'S/o'} ${b.father}`;
                if (b.isMinor && b.gName) {
                    s += ` [Minor. Guardian: ${b.gName}`;
                    if (b.gRel) s += ` (${b.gRel})`;
                    if (b.gFather && b.gFather.trim()) s += `, ${b.relPrefix || 'S/o'} ${b.gFather}`;
                    if (b.gAddr) s += `, R/o ${b.gAddr}`;
                    s += `]`;
                }
                return s;
            };

            assets.forEach((asset, idx) => {
                checkY(30);
                doc.setFont("times", "bold"); doc.setFontSize(13); doc.text(`${idx + 1}. ${asset.type.toUpperCase()}`, margin, y); y += 6;
                printAssetDetail("Description", asset.desc);
                doc.setFont("times", "italic"); doc.setFontSize(11); doc.text("Beneficiaries:", margin + 5, y); y += 6;
                doc.setFont("times", "normal"); doc.setFontSize(12);
                asset.shares.forEach((share, sIdx) => {
                    const p = gB(share.benId); const a = gB(share.altId); if (!p) return;
                    const lines = doc.splitTextToSize(`(${String.fromCharCode(97 + sIdx)}) ${share.share}% to ${getBenString(p)}`, contentWidth - 15);
                    checkY(lines.length * 6); doc.text(lines, margin + 10, y); y += (lines.length * 6);
                    if (a) {
                        doc.setFontSize(10); doc.setTextColor(80);
                        const altLines = doc.splitTextToSize(`Alternate: ${getBenString(a)}`, contentWidth - 15);
                        checkY(altLines.length * 5); doc.text(altLines, margin + 15, y); y += (altLines.length * 5) + 2;
                        doc.setTextColor(0); doc.setFontSize(12);
                    } else y += 2;
                });
                y += 4;
            });

            printSectionHeader("4. RESIDUAL CLAUSE");
            printBlock("All other property (Rest, Residue, and Remainder) I bequeath to:");
            rShares.forEach((r, idx) => {
                const p = gB(r.benId); const a = gB(r.altId); if (!p) return;

                // Primary Beneficiary - use splitTextToSize to prevent overflow
                const shareText = `(${String.fromCharCode(97 + idx)}) ${r.share}% to ${getBenString(p)}`;
                const shareLines = doc.splitTextToSize(shareText, contentWidth - 5);
                checkY(shareLines.length * lineHeight);
                doc.text(shareLines, margin + 5, y);
                y += (shareLines.length * lineHeight) + 2;

                // Alternate Beneficiary - use splitTextToSize to prevent overflow
                if (a) {
                    doc.setFontSize(10); doc.setTextColor(80);
                    const altText = `Alternate: ${getBenString(a)}`;
                    const altLines = doc.splitTextToSize(altText, contentWidth - 10);
                    checkY(altLines.length * 5);
                    doc.text(altLines, margin + 10, y);
                    y += (altLines.length * 5) + 2;
                    doc.setTextColor(0); doc.setFontSize(12);
                }
            });
            y += 5;

            checkY(135);
            doc.setFont("times", "bold"); doc.setFontSize(12); doc.text("IN WITNESS WHEREOF,", margin, y); y += 6;
            doc.setFont("times", "normal");
            const signingDate = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
            printBlock(`I have set my hand to this Will at ${gV('myPlace')} on ${signingDate}.`);
            y += 20;

            doc.setLineWidth(0.5); doc.line(margin, y, margin + 60, y); y += 5;
            doc.setFont("times", "bold"); doc.text("TESTATOR SIGNATURE", margin, y); doc.setFont("times", "normal"); doc.text(`(${gV('myName')})`, margin, y + 6); y += 20;

            doc.setFont("times", "bold"); doc.text("SIGNED BY THE WITNESSES", margin, y); doc.setFont("times", "normal"); y += 6;
            const witLines = doc.splitTextToSize("We certify that the Testator signed this Will in our presence, and we have signed as witnesses in their presence.", contentWidth);
            doc.text(witLines, margin, y); y += (witLines.length * 6) + 10;

            const col1 = margin, col2 = margin + 90;
            doc.setFont("times", "bold"); doc.text("Witness 1:", col1, y); doc.text("Witness 2:", col2, y); doc.setFont("times", "normal"); y += 15;
            doc.setLineWidth(0.2); doc.line(col1, y, col1 + 50, y); doc.line(col2, y, col2 + 50, y); y += 5;
            doc.text("Signature", col1, y); doc.text("Signature", col2, y); y += 12;
            doc.text("Name: ___________________", col1, y); doc.text("Name: ___________________", col2, y); y += 8;
            doc.text("Address: _________________", col1, y); doc.text("Address: _________________", col2, y);

            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150); doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, 290, { align: "right" });
                if (i < totalPages) {
                    doc.setDrawColor(150); doc.line(margin, 265, pageWidth - margin, 265);
                    doc.setFontSize(8); doc.setTextColor(100); doc.text("Signatures required on every page:", margin, 270);
                    const footerY = 280; doc.setTextColor(0); doc.setFontSize(10);
                    doc.setDrawColor(0); doc.setLineWidth(0.2);
                    doc.line(margin, footerY - 5, margin + 50, footerY - 5); doc.line(margin + 65, footerY - 5, margin + 115, footerY - 5); doc.line(margin + 130, footerY - 5, margin + 180, footerY - 5);
                    doc.text("TESTATOR", margin, footerY); doc.text("WITNESS 1", margin + 65, footerY); doc.text("WITNESS 2", margin + 130, footerY);
                }
            }
            doc.save(`Will_${gV('myName').replace(/\s+/g, '_')}.pdf`);
        }

        function generateRTF() {
            // Get translations for current language
            const t = TRANSLATIONS[currentLang];

            // Helpers
            const escapeRTF = (text) => {
                if (!text) return "";
                // Basic RTF escaping
                return text.toString()
                    .replace(/\\/g, "\\\\")
                    .replace(/\{/g, "\\{")
                    .replace(/\}/g, "\\}")
                    .replace(/\n/g, "\\par "); // Newlines to par
            };

            // To handle unicode characters, we need to escape them as \uN?
            const encodeRTF = (str) => {
                return escapeRTF(str).replace(/[^\x00-\x7F]/g, function (c) {
                    return '\\u' + c.charCodeAt(0) + '?';
                });
            };

            const gV = (id) => document.getElementById(id).value;
            const gB = (id) => beneficiaries.find(b => b.id == id);
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));

            // RTF Header with Margins (1 inch)
            let rtf = `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Times New Roman;}}\\margl1440\\margr1440\\margt1440\\margb1440\\f0\\fs24 \n`;

            // Empty Header (to prevent default header box)
            rtf += `{\\header \\pard \\par}\n`;

            // Footer definition - Simplified for compatibility
            // Using \ql (left align) and explicit spaces instead of tabs for better control
            const footerText = currentLang === 'en'
                ? `Signatures required on every page:\\par \\pard\\fs20\\sa100 \\par ____________________      ____________________      ____________________\\par ${t.pdfTestatorLabel}                  ${t.pdfWitness1Label}                  ${t.pdfWitness2Label}\\par`
                : `‡§π‡§∞ ‡§™‡•á‡§ú ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï:\\par \\pard\\fs20\\sa100 \\par ____________________      ____________________      ____________________\\par ${encodeRTF(t.pdfTestatorLabel)}                  ${encodeRTF(t.pdfWitness1Label)}                  ${encodeRTF(t.pdfWitness2Label)}\\par`;
            rtf += `{\\footer \\pard\\fs16\\cf1 ${footerText}}\n`;

            // Initialize Section
            rtf += `\\sectd\\margl1440\\margr1440\\margt1440\\margb1440\\headery720\\footery720\n`;

            // Title
            rtf += `\\pard\\qc\\b\\fs44 ${encodeRTF(t.pdfTitle)}\\b0\\fs24\\par \n`;
            rtf += `\\brdrb\\brdrs\\brdrw10\\brsp20 \\par \\pard\\sa180\\sl276\\slmult1 \\par \n`; // Line and reset paragraph

            // Preamble
            let religionTxt = gV('religionSelector');
            if (religionTxt === 'Other') religionTxt = gV('customReligion') || 'Other';
            const myName = gV('myName').toUpperCase();
            const fatherName = gV('fatherName').trim();
            const myRelPrefix = gV('myRelPrefix') || 'S/o';
            const myDobVal = gV('myDob');
            let dobText = "";
            if (myDobVal) {
                const dobDate = new Date(myDobVal);
                const dobStr = dobDate.toLocaleDateString(currentLang === 'hi' ? 'hi-IN' : 'en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
                dobText = currentLang === 'en' ? `, born on ${dobStr}` : `, ‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø ${dobStr}`;
            }

            // Determine gender for Hindi grammar
            const isFemale = (myRelPrefix === 'D/o' || myRelPrefix === 'W/o');
            const fixHindiGender = (text) => {
                if (currentLang !== 'hi') return text;
                if (isFemale) {
                    return text.replace(/‡§ï‡§∞‡§§‡§æ\/‡§ï‡§∞‡§§‡•Ä/g, '‡§ï‡§∞‡§§‡•Ä')
                        .replace(/‡§¨‡§®‡§æ‡§§‡§æ\/‡§¨‡§®‡§æ‡§§‡•Ä/g, '‡§¨‡§®‡§æ‡§§‡•Ä')
                        .replace(/‡§∞‡§π‡§æ\/‡§∞‡§π‡•Ä/g, '‡§∞‡§π‡•Ä')
                        .replace(/‡§π‡•Ç‡§Ç/g, '‡§π‡•Ç‡§Ç'); // Keep as is for female
                } else {
                    return text.replace(/‡§ï‡§∞‡§§‡§æ\/‡§ï‡§∞‡§§‡•Ä/g, '‡§ï‡§∞‡§§‡§æ')
                        .replace(/‡§¨‡§®‡§æ‡§§‡§æ\/‡§¨‡§®‡§æ‡§§‡•Ä/g, '‡§¨‡§®‡§æ‡§§‡§æ')
                        .replace(/‡§∞‡§π‡§æ\/‡§∞‡§π‡•Ä/g, '‡§∞‡§π‡§æ'); // FIX: was '‡§∞‡§π‡•Ä', should be '‡§∞‡§π‡§æ' for male
                }
            };
            // Helper function to translate relationship prefixes to Hindi
            const translateRelPrefix = (prefix) => {
                if (currentLang !== 'hi') return prefix;
                const translations = {
                    'S/o': '‡§™‡•Å‡§§‡•ç‡§∞',
                    'D/o': '‡§™‡•Å‡§§‡•ç‡§∞‡•Ä',
                    'W/o': '‡§™‡§§‡•ç‡§®‡•Ä',
                    'R/o': '‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä'
                };
                return translations[prefix] || prefix;
            };

            // Helper to translate "S/o Name" -> "‡§™‡•Å‡§§‡•ç‡§∞ Name"
            const translateParentName = (fullString) => {
                if (!fullString || currentLang !== 'hi') return fullString;
                const parts = fullString.split(' ');
                if (parts.length > 1) {
                    const prefix = parts[0];
                    const translatedPrefix = translateRelPrefix(prefix);
                    if (translatedPrefix !== prefix) {
                        return translatedPrefix + ' ' + parts.slice(1).join(' ');
                    }
                }
                return fullString;
            };

            let preamble = currentLang === 'en'
                ? `I, \\b ${encodeRTF(myName)}\\b0`
                : `${encodeRTF(t.pdfIAppoint.split(' ')[0])}, \\b ${encodeRTF(myName)}\\b0`;
            if (fatherName) preamble += `, ${encodeRTF(translateRelPrefix(myRelPrefix))} ${encodeRTF(fatherName)}`;
            if (dobText) preamble += encodeRTF(dobText);

            let preambleEnd = `, ${encodeRTF(t.pdfResidingAt)} ${encodeRTF(gV('myAddress'))} (‡§ß‡§∞‡•ç‡§Æ: ${encodeRTF(religionTxt)}), ${encodeRTF(t.pdfBeingOfSound)}`;
            if (currentLang === 'hi') {
                preambleEnd = fixHindiGender(preambleEnd);
            }
            preamble += preambleEnd;

            rtf += `${preamble}\\par\\par \n`;

            // 1. Revocation
            rtf += `\\b\\fs28 ${encodeRTF(t.pdfRevocationTitle)}\\b0\\fs24\\par \n`;
            let revocationText = t.pdfRevocationText;
            if (currentLang === 'hi') revocationText = fixHindiGender(revocationText);
            rtf += `${encodeRTF(revocationText)}\\par\\par \n`;

            // 2. Executor
            rtf += `\\b\\fs28 ${encodeRTF(t.pdfExecutorTitle)}\\b0\\fs24\\par \n`;
            // Ensure we have the latest executor data
            const currentExecutors = collectExecutors();
            const primaryExecutors = currentExecutors.filter(e => e.isPrimary);
            const alternateExecutor = currentExecutors.find(e => !e.isPrimary);

            if (primaryExecutors.length > 0) {
                // Only show "Primary Executor(s)" heading when alternate exists (to distinguish from alternate)
                if (alternateExecutor) {
                    rtf += `\\b\\fs24 ${encodeRTF(t.previewPrimaryExecutors)}\\b0\\par \n`;
                }
                if (primaryExecutors.length === 1) {
                    const ex = primaryExecutors[0];
                    let execText = `${encodeRTF(t.pdfIAppoint)} \\b ${encodeRTF(ex.name.toUpperCase())} \\b0 (${encodeRTF(t.pdfRelLabel)}: ${encodeRTF(ex.relationship)})`;
                    if (ex.parentName) execText += `, ${encodeRTF(translateParentName(ex.parentName))}`;
                    if (ex.address) execText += `, ${encodeRTF(t.pdfResidingAt)} ${encodeRTF(ex.address)}`;
                    execText += `, ${encodeRTF(t.pdfToBeThe)}`;
                    if (currentLang === 'hi') execText = fixHindiGender(execText);
                    rtf += `${execText}\\par\\par \n`;
                } else {
                    rtf += `${encodeRTF(t.previewExecutorClause)}\\par \n`;
                    primaryExecutors.forEach((ex, index) => {
                        let execText = `${index + 1}. \\b ${encodeRTF(ex.name.toUpperCase())} \\b0 (${encodeRTF(t.pdfRelLabel)}: ${encodeRTF(ex.relationship)})`;
                        if (ex.parentName) execText += `, ${encodeRTF(translateParentName(ex.parentName))}`;
                        if (ex.address) execText += `, ${encodeRTF(t.pdfResidingAt)} ${encodeRTF(ex.address)}`;
                        rtf += `\\li720 ${execText}\\par \n`; // Indent list items
                    });
                    rtf += `\\li0 \\i ${encodeRTF(t.previewJointSeveral)}\\i0 \\par\\par \n`; // Reset indent
                }
            }

            if (alternateExecutor) {
                rtf += `\\par \\b\\fs24 ${encodeRTF(t.previewAlternateExecutor)}\\b0\\par \n`;
                rtf += `${encodeRTF(t.previewAlternateClause)}\\par \n`;
                let altText = `\\b ${encodeRTF(alternateExecutor.name.toUpperCase())} \\b0 (${encodeRTF(t.pdfRelLabel)}: ${encodeRTF(alternateExecutor.relationship)})`;
                if (alternateExecutor.parentName) altText += `, ${encodeRTF(translateParentName(alternateExecutor.parentName))}`;
                if (alternateExecutor.address) altText += `, ${encodeRTF(t.pdfResidingAt)} ${encodeRTF(alternateExecutor.address)}`;
                rtf += `${altText}\\par\\par \n`;
            }

            // 3. Assets
            rtf += `\\b\\fs28 ${encodeRTF(t.pdfDistributionTitle)}\\b0\\fs24\\par \n`;
            let distIntro = t.pdfDistributionIntro;
            if (currentLang === 'hi') distIntro = fixHindiGender(distIntro);
            rtf += `${encodeRTF(distIntro)}\\par\\par \n`;

            const assets = data.assets || [];

            const getBenStringRTF = (b) => {
                if (!b) return "Unknown";
                let s = `\\b ${encodeRTF(b.name)}\\b0 (${encodeRTF(b.rel)})`;
                if (b.addr) s += `, R/o ${encodeRTF(b.addr)}`;
                if (b.father && b.father.trim()) s += `, ${encodeRTF(b.relPrefix || 'S/o')} ${encodeRTF(b.father)}`;
                if (b.isMinor && b.gName) {
                    s += ` [${encodeRTF(t.pdfMinorLabel)}. ${encodeRTF(t.pdfGuardianLabel)}: ${encodeRTF(b.gName)}`;
                    if (b.gRel) s += ` (${encodeRTF(b.gRel)})`;
                    if (b.gFather && b.gFather.trim()) s += `, ${encodeRTF(b.gRelPrefix || 'S/o')} ${encodeRTF(b.gFather)}`;
                    if (b.gAddr) s += `, R/o ${encodeRTF(b.gAddr)}`;
                    s += `]`;
                }
                return s;
            };

            assets.forEach((asset, idx) => {
                rtf += `\\b ${idx + 1}. ${encodeRTF(asset.type.toUpperCase())}\\b0\\par \n`;
                rtf += `\\b ${encodeRTF(t.pdfDescriptionLabel)}: \\b0 ${encodeRTF(asset.desc)}\\par \n`;
                rtf += `\\i ${encodeRTF(t.pdfBeneficiariesLabel)}:\\i0\\par \n`;

                asset.shares.forEach((share, sIdx) => {
                    const p = gB(share.benId);
                    const a = gB(share.altId);
                    if (!p) return;
                    rtf += `\\tab (${String.fromCharCode(97 + sIdx)}) ${share.share}% to ${getBenStringRTF(p)}\\par \n`;
                    if (a) {
                        rtf += `\\tab\\tab ${encodeRTF(t.pdfAlternateLabel)}: ${getBenStringRTF(a)}\\par \n`;
                    }
                });
                rtf += `\\par \n`;
            });

            // 4. Residual
            rtf += `\\b\\fs28 ${encodeRTF(t.pdfResidualTitle)}\\b0\\fs24\\par \n`;
            let resIntro = t.pdfResidualIntro;
            if (currentLang === 'hi') resIntro = fixHindiGender(resIntro);
            rtf += `${encodeRTF(resIntro)}\\par\\par \n`;
            const rShares = collectResidualShares();
            rShares.forEach((r, idx) => {
                const p = gB(r.benId);
                const a = gB(r.altId);
                if (!p) return;
                rtf += `\\tab (${String.fromCharCode(97 + idx)}) ${r.share}% to ${getBenStringRTF(p)}\\par \n`;
                if (a) {
                    rtf += `\\tab\\tab ${encodeRTF(t.pdfAlternateLabel)}: ${getBenStringRTF(a)}\\par \n`;
                }
            });
            rtf += `\\par \n`;

            // Signatures
            rtf += `\\par\\par \n`;
            rtf += `\\b ${encodeRTF(t.pdfSignatureText)}\\b0\\par \n`;
            const today = new Date().toLocaleDateString(currentLang === 'en' ? 'en-IN' : 'hi-IN', { year: 'numeric', month: 'long', day: 'numeric' });
            const witnessText = currentLang === 'en'
                ? `I have set my hand to this Will at ${encodeRTF(gV('myPlace'))} on ${today}.`
                : `‡§Æ‡•à‡§Ç‡§®‡•á ${encodeRTF(gV('myPlace'))} ‡§Æ‡•á‡§Ç ${today} ‡§ï‡•ã ‡§á‡§∏ ‡§µ‡§∏‡•Ä‡§Ø‡§§ ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§`;
            rtf += `${witnessText}\\par\\par\\par \n`;

            // Testator Line
            rtf += `____________________________\\par \n`;
            const testatorSigLabel = currentLang === 'en' ? 'TESTATOR SIGNATURE' : '‡§µ‡§∏‡•Ä‡§Ø‡§§‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞';
            rtf += `\\b ${encodeRTF(testatorSigLabel)}\\b0\\par \n`;
            rtf += `(${encodeRTF(myName)})\\par\\par\\par \n`;

            // Witnesses
            const witnessesTitle = currentLang === 'en' ? 'SIGNED BY THE WITNESSES' : '‡§ó‡§µ‡§æ‡§π‡•ã‡§Ç ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§ø‡§§';
            const witnessCert = currentLang === 'en'
                ? 'We certify that the Testator signed this Will in our presence, and we have signed as witnesses in their presence.'
                : '‡§π‡§Æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§µ‡§∏‡•Ä‡§Ø‡§§‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§µ‡§∏‡•Ä‡§Ø‡§§ ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç, ‡§î‡§∞ ‡§π‡§Æ‡§®‡•á ‡§â‡§®‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§ó‡§µ‡§æ‡§π‡•ã‡§Ç ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§';
            rtf += `\\b ${encodeRTF(witnessesTitle)}\\b0\\par \n`;
            rtf += `${encodeRTF(witnessCert)}\\par\\par \n`;

            // Simple Witness Layout for RTF (Table or Tabs)
            // Using Tabs for simplicity in RTF
            rtf += `\\b ${encodeRTF(t.pdfWitness1Label)}:\\b0 \\tab\\tab\\tab\\tab\\tab \\b ${encodeRTF(t.pdfWitness2Label)}:\\b0\\par \n`;
            rtf += `_____________________ \\tab\\tab\\tab _____________________\\par \n`;
            const sigLabel = currentLang === 'en' ? 'Signature' : '‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞';
            const nameLabel = currentLang === 'en' ? 'Name' : '‡§®‡§æ‡§Æ';
            const addrLabel = currentLang === 'en' ? 'Addr' : '‡§™‡§§‡§æ';
            rtf += `${encodeRTF(sigLabel)} \\tab\\tab\\tab\\tab\\tab ${encodeRTF(sigLabel)}\\par\\par \n`;
            rtf += `${encodeRTF(nameLabel)}: _________________ \\tab\\tab\\tab ${encodeRTF(nameLabel)}: _________________\\par \n`;
            rtf += `${encodeRTF(addrLabel)}: __________________ \\tab\\tab\\tab ${encodeRTF(addrLabel)}: __________________\\par \n`;

            rtf += `}`; // End RTF

            // Download
            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Will_${myName.replace(/\s+/g, '_')}.rtf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    <!-- Executor Bottom Sheet (Single Executor Form) -->
    <div id="executor-sheet-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300"
        onclick="closeExecutorSheet()"></div>
    <div id="executor-sheet"
        class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 transform translate-y-full transition-transform duration-300 max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <button onclick="closeExecutorSheet()" class="text-gray-600 hover:text-gray-800 p-2 -ml-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h3 class="text-lg font-bold text-gray-800" id="sheet-executor-title" data-i18n="sheetExecutorTitle">Manage
                Executor</h3>
            <div class="w-10"></div> <!-- Spacer for centering -->
        </div>

        <!-- Single Executor Form -->
        <div class="p-4 space-y-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblExName">Executor Name
                    <span class="text-red-500">*</span></label>
                <input type="text" id="sheet-ex-name"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    placeholder="Full Name">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblExRel">Relationship <span
                        class="text-red-500">*</span></label>
                <input type="text" id="sheet-ex-rel"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    placeholder="e.g. Brother">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblExParentName">Parent /
                    Spouse Name</label>
                <div class="flex gap-2">
                    <select id="sheet-ex-prefix"
                        class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                        <option value="S/o">S/o</option>
                        <option value="D/o">D/o</option>
                        <option value="W/o">W/o</option>
                    </select>
                    <input type="text" id="sheet-ex-parent"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="Father's / Husband's Name">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lblExAddress">Address</label>
                <textarea id="sheet-ex-address"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" rows="3"
                    placeholder="Current Address"></textarea>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200">
            <button onclick="saveExecutorSheet()"
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg"
                data-i18n="btnDone">Save Executor</button>
        </div>
    </div>

    <script type="module" src="/index.tsx"></script>
</body>

</html>